<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="SemidÃ¡n Robaina" /><link rel="canonical" href="https://robaina.github.io/MetaTag/references/api/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>API references - MetaTag</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "API references";
        var mkdocs_page_input_path = "references/api.md";
        var mkdocs_page_url = "/MetaTag/references/api/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> MetaTag
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Subcommands</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/preprocess/">Preprocess</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/database/">Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/tree/">Tree</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/place/">Place</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/assign/">Assign</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/count/">Count</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/plot/">Plot</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../subcommands/relabel/">Relabel</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">API references</a>
    <ul class="current">
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">MetaTag</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>References &raquo;</li>
      <li>API references</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/Robaina/MetaTag/edit/master/docs/references/api.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="module-pipelines">Module pipelines</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.pipelines"></a>
  <div class="doc doc-contents first">
  
      <p>Pre-set pipelines to infer trees and place and label env sequences</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.pipelines.CommandArgs" class="doc doc-heading">
        <code>CommandArgs</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Base class to hold command line arguments.</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CommandArgs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class to hold command line arguments.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.pipelines.QueryLabeller" class="doc doc-heading">
        <code>QueryLabeller</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Place queries onto reference tree and assign function and taxonomy</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">QueryLabeller</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Place queries onto reference tree and assign function and taxonomy</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_query</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">reference_alignment</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">reference_tree</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">reference_labels</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">tree_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tree_clusters</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">tree_cluster_scores</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">tree_cluster_score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alignment_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;papara&quot;</span><span class="p">,</span>
        <span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">maximum_placement_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">distance_measure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pendant_diameter_ratio&quot;</span><span class="p">,</span>
        <span class="n">minimum_placement_lwr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">        Args:</span>
<span class="sd">            input_query (Path): _description_</span>
<span class="sd">            reference_alignment (Path): _description_</span>
<span class="sd">            reference_tree (Path): _description_</span>
<span class="sd">            tree_model (str): _description_</span>
<span class="sd">            tree_clusters (Path): _description_</span>
<span class="sd">            tree_cluster_scores (Path): _description_</span>
<span class="sd">            reference_labels (Path, optional): _description_.</span>
<span class="sd">            alignment_method (str, optional): _description_. Defaults to &quot;papara&quot;.</span>
<span class="sd">            output_directory (Path, optional): _description_. Defaults to None.</span>
<span class="sd">            maximum_placement_distance (float, optional): _description_. Defaults to 1.0.</span>
<span class="sd">            distance_measure (str, optional): _description_. Defaults to &quot;pendant_diameter_ratio&quot;.</span>
<span class="sd">            minimum_placement_lwr (float, optional): _description_. Defaults to 0.8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_query</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_alignment</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">reference_alignment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_tree</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">reference_tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_model</span><span class="p">)</span> <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_model</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="n">tree_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_clusters</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_clusters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_scores</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_cluster_scores</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_score_threshold</span> <span class="o">=</span> <span class="n">tree_cluster_score_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alignment_method</span> <span class="o">=</span> <span class="n">alignment_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_labels</span> <span class="o">=</span> <span class="n">reference_labels</span>
        <span class="k">if</span> <span class="n">output_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_query</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;placement_results&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="o">=</span> <span class="n">maximum_placement_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_measure</span> <span class="o">=</span> <span class="n">distance_measure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="o">=</span> <span class="n">minimum_placement_lwr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_query</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;query_cleaned.faa&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_query_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;query_cleaned_id_dict.pickle&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;placements&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;assignments&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">count_outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;counts&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result.jplace&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result.jplace&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result_lwr_filtered.jplace&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result_distance_filtered.jplace&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result_distance_filtered_lwr_filtered.jplace&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_placements_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result.newick&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_taxtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span> <span class="o">/</span> <span class="s2">&quot;placed_tax_assignments.tsv&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run pipeline to annotate query sequences through evolutionary placement.&quot;&quot;&quot;</span>
        <span class="n">preprocess_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_query</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_query</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">relabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">idprefix</span><span class="o">=</span><span class="s2">&quot;query_&quot;</span><span class="p">,</span>
            <span class="n">export_dup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">duplicate_method</span><span class="o">=</span><span class="s2">&quot;seqkit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">preprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">preprocess_args</span><span class="p">)</span>

        <span class="n">place_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">aln</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_alignment</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_tree</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_query</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">aln_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alignment_method</span><span class="p">,</span>
            <span class="n">tree_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">placesequences</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">place_args</span><span class="p">)</span>

        <span class="n">assign_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">jplace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_labels</span><span class="p">,</span>
            <span class="n">query_labels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_query_labels</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
            <span class="n">ref_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_clusters</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">ref_cluster_scores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_scores</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;placed_tax_&quot;</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">max_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span><span class="p">,</span>
            <span class="n">distance_measure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_measure</span><span class="p">,</span>
            <span class="n">minimum_lwr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span><span class="p">,</span>
            <span class="n">duplicated_query_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">taxofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">labelplacements</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">assign_args</span><span class="p">)</span>

        <span class="n">count_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">taxtable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_taxtable</span><span class="p">,</span>
            <span class="n">taxlevels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;genus&quot;</span><span class="p">,</span> <span class="s2">&quot;family&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;phylum&quot;</span><span class="p">],</span>
            <span class="n">cluster_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_score_threshold</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_outdir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outprefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">export_right_queries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">countplacements</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">count_args</span><span class="p">)</span>

        <span class="n">relabel_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_placements_tree</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_labels</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_query_labels</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
            <span class="n">labelprefixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ref_&quot;</span><span class="p">,</span> <span class="s2">&quot;query_&quot;</span><span class="p">],</span>
            <span class="n">taxonomy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">aln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">taxofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">relabeltree</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">relabel_args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.pipelines.QueryLabeller.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">input_query</span><span class="p">,</span> <span class="n">reference_alignment</span><span class="p">,</span> <span class="n">reference_tree</span><span class="p">,</span> <span class="n">reference_labels</span><span class="p">,</span> <span class="n">tree_model</span><span class="p">,</span> <span class="n">tree_clusters</span><span class="p">,</span> <span class="n">tree_cluster_scores</span><span class="p">,</span> <span class="n">tree_cluster_score_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alignment_method</span><span class="o">=</span><span class="s1">&#39;papara&#39;</span><span class="p">,</span> <span class="n">output_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maximum_placement_distance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">distance_measure</span><span class="o">=</span><span class="s1">&#39;pendant_diameter_ratio&#39;</span><span class="p">,</span> <span class="n">minimum_placement_lwr</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p><em>summary</em></p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_query</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>reference_alignment</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>reference_tree</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tree_model</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tree_clusters</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tree_cluster_scores</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>reference_labels</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>alignment_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><em>description</em>. Defaults to "papara".</p></td>
          <td>
                <code>&#39;papara&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>output_directory</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em>. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>maximum_placement_distance</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p><em>description</em>. Defaults to 1.0.</p></td>
          <td>
                <code>1.0</code>
          </td>
        </tr>
        <tr>
          <td><code>distance_measure</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><em>description</em>. Defaults to "pendant_diameter_ratio".</p></td>
          <td>
                <code>&#39;pendant_diameter_ratio&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>minimum_placement_lwr</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p><em>description</em>. Defaults to 0.8.</p></td>
          <td>
                <code>0.8</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_query</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">reference_alignment</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">reference_tree</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">reference_labels</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">tree_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tree_clusters</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">tree_cluster_scores</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">tree_cluster_score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alignment_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;papara&quot;</span><span class="p">,</span>
    <span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">maximum_placement_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">distance_measure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pendant_diameter_ratio&quot;</span><span class="p">,</span>
    <span class="n">minimum_placement_lwr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_</span>

<span class="sd">    Args:</span>
<span class="sd">        input_query (Path): _description_</span>
<span class="sd">        reference_alignment (Path): _description_</span>
<span class="sd">        reference_tree (Path): _description_</span>
<span class="sd">        tree_model (str): _description_</span>
<span class="sd">        tree_clusters (Path): _description_</span>
<span class="sd">        tree_cluster_scores (Path): _description_</span>
<span class="sd">        reference_labels (Path, optional): _description_.</span>
<span class="sd">        alignment_method (str, optional): _description_. Defaults to &quot;papara&quot;.</span>
<span class="sd">        output_directory (Path, optional): _description_. Defaults to None.</span>
<span class="sd">        maximum_placement_distance (float, optional): _description_. Defaults to 1.0.</span>
<span class="sd">        distance_measure (str, optional): _description_. Defaults to &quot;pendant_diameter_ratio&quot;.</span>
<span class="sd">        minimum_placement_lwr (float, optional): _description_. Defaults to 0.8.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_query</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_query</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reference_alignment</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">reference_alignment</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reference_tree</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">reference_tree</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_model</span><span class="p">)</span> <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_model</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="n">tree_model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_clusters</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_clusters</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_scores</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tree_cluster_scores</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_score_threshold</span> <span class="o">=</span> <span class="n">tree_cluster_score_threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alignment_method</span> <span class="o">=</span> <span class="n">alignment_method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reference_labels</span> <span class="o">=</span> <span class="n">reference_labels</span>
    <span class="k">if</span> <span class="n">output_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_query</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;placement_results&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="o">=</span> <span class="n">maximum_placement_distance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distance_measure</span> <span class="o">=</span> <span class="n">distance_measure</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="o">=</span> <span class="n">minimum_placement_lwr</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_query</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;query_cleaned.faa&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_query_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;query_cleaned_id_dict.pickle&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;placements&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;assignments&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">count_outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;counts&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count_outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result.jplace&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result.jplace&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result_lwr_filtered.jplace&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result_distance_filtered.jplace&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_jplace</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result_distance_filtered_lwr_filtered.jplace&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">out_placements_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span> <span class="o">/</span> <span class="s2">&quot;epa_result.newick&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_taxtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span> <span class="o">/</span> <span class="s2">&quot;placed_tax_assignments.tsv&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.pipelines.QueryLabeller.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Run pipeline to annotate query sequences through evolutionary placement.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run pipeline to annotate query sequences through evolutionary placement.&quot;&quot;&quot;</span>
    <span class="n">preprocess_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_query</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_query</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">relabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">idprefix</span><span class="o">=</span><span class="s2">&quot;query_&quot;</span><span class="p">,</span>
        <span class="n">export_dup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">duplicate_method</span><span class="o">=</span><span class="s2">&quot;seqkit&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">preprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">preprocess_args</span><span class="p">)</span>

    <span class="n">place_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">aln</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_alignment</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_tree</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_query</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">place_outdir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">aln_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alignment_method</span><span class="p">,</span>
        <span class="n">tree_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">placesequences</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">place_args</span><span class="p">)</span>

    <span class="n">assign_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">jplace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_labels</span><span class="p">,</span>
        <span class="n">query_labels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_query_labels</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
        <span class="n">ref_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_clusters</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">ref_cluster_scores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_scores</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;placed_tax_&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_outdir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">max_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_placement_distance</span><span class="p">,</span>
        <span class="n">distance_measure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_measure</span><span class="p">,</span>
        <span class="n">minimum_lwr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minimum_placement_lwr</span><span class="p">,</span>
        <span class="n">duplicated_query_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">taxofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">labelplacements</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">assign_args</span><span class="p">)</span>

    <span class="n">count_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">taxtable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_taxtable</span><span class="p">,</span>
        <span class="n">taxlevels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;genus&quot;</span><span class="p">,</span> <span class="s2">&quot;family&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;phylum&quot;</span><span class="p">],</span>
        <span class="n">cluster_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_cluster_score_threshold</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_outdir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outprefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">export_right_queries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">countplacements</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">count_args</span><span class="p">)</span>

    <span class="n">relabel_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_placements_tree</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_labels</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_query_labels</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
        <span class="n">labelprefixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ref_&quot;</span><span class="p">,</span> <span class="s2">&quot;query_&quot;</span><span class="p">],</span>
        <span class="n">taxonomy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">aln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">taxofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">relabeltree</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">relabel_args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.pipelines.ReferenceTreeBuilder" class="doc doc-heading">
        <code>ReferenceTreeBuilder</code>


</h2>


  <div class="doc doc-contents ">

  
      <p><em>summary</em></p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ReferenceTreeBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;_summary_&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_database</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">hmms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
        <span class="n">maximum_hmm_reference_sizes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">minimum_sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">maximum_sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">translate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">relabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">remove_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">relabel_prefixes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hmmsearch_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tree_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fasttree&quot;</span><span class="p">,</span>
        <span class="n">tree_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;iqtest&quot;</span><span class="p">,</span>
        <span class="n">msa_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;muscle&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruct reference phylogenetic tree from sequence database and hmms</span>

<span class="sd">        Args:</span>
<span class="sd">            input_database (Path): _description_</span>
<span class="sd">            hmms (list[Path]): _description_</span>
<span class="sd">            max_hmm_reference_size (list[int], optional): _description_. Defaults to None.</span>
<span class="sd">            min_sequence_length (int, optional): _description_. Defaults to 10.</span>
<span class="sd">            max_sequence_length (int, optional): _description_. Defaults to 1000.</span>
<span class="sd">            output_directory (Path, optional): _description_. Defaults to None.</span>
<span class="sd">            translate (bool, optional): _description_. Defaults to False.</span>
<span class="sd">            relabel (bool, optional): _description_. Defaults to True.</span>
<span class="sd">            remove_duplicates (bool, optional): _description_. Defaults to True.</span>
<span class="sd">            relabel_prefixes (list[str], optional): _description_. Defaults to None.</span>
<span class="sd">            hmmsearch_args (str, optional): _description_. Defaults to None.</span>
<span class="sd">            tree_method (str, optional): _description_. Defaults to &quot;fasttree&quot;.</span>
<span class="sd">            tree_model (str, optional): choose method to select substitution model: &quot;iqtest&quot;, &quot;modeltest&quot;,</span>
<span class="sd">                or a valid substitution model name (compatible with EPA-ng). Defaults to &quot;iqtest&quot;.</span>
<span class="sd">            msa_method (str, optional): choose msa method for reference database: &quot;muscle&quot; or &quot;mafft&quot;.</span>
<span class="sd">                Defaults to &quot;muscle&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_database</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hmms</span> <span class="o">=</span> <span class="n">hmms</span>
        <span class="k">if</span> <span class="n">maximum_hmm_reference_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_hmm_reference_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hmms</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_hmm_reference_sizes</span> <span class="o">=</span> <span class="n">maximum_hmm_reference_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_sequence_length</span> <span class="o">=</span> <span class="n">minimum_sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_sequence_length</span> <span class="o">=</span> <span class="n">maximum_sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="n">translate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relabel</span> <span class="o">=</span> <span class="n">relabel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_duplicates</span> <span class="o">=</span> <span class="n">remove_duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relabel_prefixes</span> <span class="o">=</span> <span class="n">relabel_prefixes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hmmsearch_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hmmsearch_args</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)):</span>
            <span class="n">hmmsearch_args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">hmmsearch_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hmmsearch_args</span> <span class="o">=</span> <span class="n">hmmsearch_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msa_method</span> <span class="o">=</span> <span class="n">msa_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_method</span> <span class="o">=</span> <span class="n">tree_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span> <span class="o">=</span> <span class="n">tree_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_database</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_database</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_cleaned.faa&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database.faa&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database.newick&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_alignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database.faln&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_labels</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database_id_dict.pickle&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_tree_model</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run pipeline to build reference tree.&quot;&quot;&quot;</span>

        <span class="n">preprocess_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">export_dup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">relabel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">idprefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">duplicate_method</span><span class="o">=</span><span class="s2">&quot;seqkit&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">preprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">preprocess_args</span><span class="p">)</span>

        <span class="n">database_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">hmms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hmms</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">relabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">nocdhit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">noduplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">relabel_prefixes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relabel_prefixes</span><span class="p">,</span>
            <span class="n">maxsizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_hmm_reference_sizes</span><span class="p">,</span>
            <span class="n">minseqlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minimum_sequence_length</span><span class="p">,</span>
            <span class="n">maxseqlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_sequence_length</span><span class="p">,</span>
            <span class="n">hmmsearch_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hmmsearch_args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">makedatabase</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">database_args</span><span class="p">)</span>

        <span class="n">tree_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_reference_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">msa_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msa_method</span><span class="p">,</span>
            <span class="n">tree_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span><span class="p">,</span>
            <span class="n">tree_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">buildtree</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tree_args</span><span class="p">)</span>

        <span class="n">relabel_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_reference_tree</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_reference_labels</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
            <span class="n">labelprefixes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">taxonomy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">aln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">taxofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">relabeltree</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">relabel_args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.pipelines.ReferenceTreeBuilder.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">input_database</span><span class="p">,</span> <span class="n">hmms</span><span class="p">,</span> <span class="n">maximum_hmm_reference_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minimum_sequence_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maximum_sequence_length</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">output_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">relabel_prefixes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hmmsearch_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree_method</span><span class="o">=</span><span class="s1">&#39;fasttree&#39;</span><span class="p">,</span> <span class="n">tree_model</span><span class="o">=</span><span class="s1">&#39;iqtest&#39;</span><span class="p">,</span> <span class="n">msa_method</span><span class="o">=</span><span class="s1">&#39;muscle&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Reconstruct reference phylogenetic tree from sequence database and hmms</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_database</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>hmms</code></td>
          <td>
                <code>list[<span title="pathlib.Path">Path</span>]</code>
          </td>
          <td><p><em>description</em></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_hmm_reference_size</code></td>
          <td>
                <code>list[int]</code>
          </td>
          <td><p><em>description</em>. Defaults to None.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>min_sequence_length</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p><em>description</em>. Defaults to 10.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>max_sequence_length</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p><em>description</em>. Defaults to 1000.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_directory</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p><em>description</em>. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>translate</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p><em>description</em>. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>relabel</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p><em>description</em>. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>remove_duplicates</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p><em>description</em>. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>relabel_prefixes</code></td>
          <td>
                <code>list[str]</code>
          </td>
          <td><p><em>description</em>. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>hmmsearch_args</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><em>description</em>. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tree_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p><em>description</em>. Defaults to "fasttree".</p></td>
          <td>
                <code>&#39;fasttree&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>tree_model</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>choose method to select substitution model: "iqtest", "modeltest",
or a valid substitution model name (compatible with EPA-ng). Defaults to "iqtest".</p></td>
          <td>
                <code>&#39;iqtest&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>msa_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>choose msa method for reference database: "muscle" or "mafft".
Defaults to "muscle".</p></td>
          <td>
                <code>&#39;muscle&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_database</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">hmms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
    <span class="n">maximum_hmm_reference_sizes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">minimum_sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">maximum_sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">translate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">relabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">remove_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">relabel_prefixes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hmmsearch_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tree_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fasttree&quot;</span><span class="p">,</span>
    <span class="n">tree_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;iqtest&quot;</span><span class="p">,</span>
    <span class="n">msa_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;muscle&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reconstruct reference phylogenetic tree from sequence database and hmms</span>

<span class="sd">    Args:</span>
<span class="sd">        input_database (Path): _description_</span>
<span class="sd">        hmms (list[Path]): _description_</span>
<span class="sd">        max_hmm_reference_size (list[int], optional): _description_. Defaults to None.</span>
<span class="sd">        min_sequence_length (int, optional): _description_. Defaults to 10.</span>
<span class="sd">        max_sequence_length (int, optional): _description_. Defaults to 1000.</span>
<span class="sd">        output_directory (Path, optional): _description_. Defaults to None.</span>
<span class="sd">        translate (bool, optional): _description_. Defaults to False.</span>
<span class="sd">        relabel (bool, optional): _description_. Defaults to True.</span>
<span class="sd">        remove_duplicates (bool, optional): _description_. Defaults to True.</span>
<span class="sd">        relabel_prefixes (list[str], optional): _description_. Defaults to None.</span>
<span class="sd">        hmmsearch_args (str, optional): _description_. Defaults to None.</span>
<span class="sd">        tree_method (str, optional): _description_. Defaults to &quot;fasttree&quot;.</span>
<span class="sd">        tree_model (str, optional): choose method to select substitution model: &quot;iqtest&quot;, &quot;modeltest&quot;,</span>
<span class="sd">            or a valid substitution model name (compatible with EPA-ng). Defaults to &quot;iqtest&quot;.</span>
<span class="sd">        msa_method (str, optional): choose msa method for reference database: &quot;muscle&quot; or &quot;mafft&quot;.</span>
<span class="sd">            Defaults to &quot;muscle&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_database</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_database</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hmms</span> <span class="o">=</span> <span class="n">hmms</span>
    <span class="k">if</span> <span class="n">maximum_hmm_reference_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_hmm_reference_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hmms</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_hmm_reference_sizes</span> <span class="o">=</span> <span class="n">maximum_hmm_reference_sizes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">minimum_sequence_length</span> <span class="o">=</span> <span class="n">minimum_sequence_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maximum_sequence_length</span> <span class="o">=</span> <span class="n">maximum_sequence_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="n">translate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relabel</span> <span class="o">=</span> <span class="n">relabel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">remove_duplicates</span> <span class="o">=</span> <span class="n">remove_duplicates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relabel_prefixes</span> <span class="o">=</span> <span class="n">relabel_prefixes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hmmsearch_args</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hmmsearch_args</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)):</span>
        <span class="n">hmmsearch_args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">hmmsearch_args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hmmsearch_args</span> <span class="o">=</span> <span class="n">hmmsearch_args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">msa_method</span> <span class="o">=</span> <span class="n">msa_method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_method</span> <span class="o">=</span> <span class="n">tree_method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span> <span class="o">=</span> <span class="n">tree_model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_database</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_database</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_cleaned.faa&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database.faa&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database.newick&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_alignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database.faln&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_reference_labels</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">/</span> <span class="s2">&quot;ref_database_id_dict.pickle&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_tree_model</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.pipelines.ReferenceTreeBuilder.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Run pipeline to build reference tree.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/pipelines.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run pipeline to build reference tree.&quot;&quot;&quot;</span>

    <span class="n">preprocess_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">export_dup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">relabel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">idprefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">duplicate_method</span><span class="o">=</span><span class="s2">&quot;seqkit&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">preprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">preprocess_args</span><span class="p">)</span>

    <span class="n">database_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_cleaned_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">hmms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hmms</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">relabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nocdhit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">noduplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">relabel_prefixes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relabel_prefixes</span><span class="p">,</span>
        <span class="n">maxsizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_hmm_reference_sizes</span><span class="p">,</span>
        <span class="n">minseqlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minimum_sequence_length</span><span class="p">,</span>
        <span class="n">maxseqlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_sequence_length</span><span class="p">,</span>
        <span class="n">hmmsearch_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hmmsearch_args</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">makedatabase</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">database_args</span><span class="p">)</span>

    <span class="n">tree_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_reference_database</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">msa_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msa_method</span><span class="p">,</span>
        <span class="n">tree_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_model</span><span class="p">,</span>
        <span class="n">tree_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_method</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">buildtree</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tree_args</span><span class="p">)</span>

    <span class="n">relabel_args</span> <span class="o">=</span> <span class="n">CommandArgs</span><span class="p">(</span>
        <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_reference_tree</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">out_reference_labels</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
        <span class="n">labelprefixes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">taxonomy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">aln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">taxofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">relabeltree</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">relabel_args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><h2 id="module-databasepreprocessing">Module database.preprocessing</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.database.preprocessing"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to preprocess sequence databases</p>
<ol>
<li>Remove illegal characters from peptide sequences</li>
<li>Remove illegal symbols from file paths</li>
<li>Relabel fasta records and make dictionary with old labels</li>
</ol>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.assert_correct_file_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assert_correct_file_path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Remove illegal symbols from file path</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assert_correct_file_path</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove illegal symbols from file path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">upper_lower_digits</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[^a-zA-Z0-9]&quot;</span><span class="p">)</span>
    <span class="n">fdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
    <span class="n">clean_fname</span> <span class="o">=</span> <span class="n">upper_lower_digits</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">clean_fname</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.assert_correct_sequence_format" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assert_correct_sequence_format</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_peptide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Filter out (DNA or peptide) sequences containing illegal characters</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@handle_exceptions</span>
<span class="k">def</span> <span class="nf">assert_correct_sequence_format</span><span class="p">(</span>
    <span class="n">fasta_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">is_peptide</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">remove</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out (DNA or peptide) sequences containing illegal characters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_stop_codon_signals</span><span class="p">(</span><span class="n">record_seq</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">record_seq</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">_modified</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_peptide</span><span class="p">:</span>
        <span class="n">is_legit_sequence</span> <span class="o">=</span> <span class="n">is_legit_peptide_sequence</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_legit_sequence</span> <span class="o">=</span> <span class="n">is_legit_dn_asequence</span>

    <span class="n">fasta</span> <span class="o">=</span> <span class="n">pyfastx</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="n">build_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">record_name</span><span class="p">,</span> <span class="n">record_seq</span> <span class="ow">in</span> <span class="n">fasta</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_peptide</span><span class="p">:</span>
                <span class="n">record_seq</span> <span class="o">=</span> <span class="n">remove_stop_codon_signals</span><span class="p">(</span><span class="n">record_seq</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_legit_sequence</span><span class="p">(</span><span class="n">record_seq</span><span class="p">):</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">record_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.fasta_contains_nucleotide_sequences" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fasta_contains_nucleotide_sequences</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Check whether fasta file contains nucleotide sequences</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fasta_contains_nucleotide_sequences</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether fasta file contains nucleotide sequences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ffile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">seq_1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ffile</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">))</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">seq_1</span><span class="o">.</span><span class="n">seq</span>
    <span class="n">ffile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">is_legit_dn_asequence</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.fastq2fasta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fastq2fasta</span><span class="p">(</span><span class="n">input_fastq</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert Fastq to FASTA format via sed</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fastq2fasta</span><span class="p">(</span><span class="n">input_fastq</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unzip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert Fastq to FASTA format via sed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fastq</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.fasta&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unzip</span><span class="p">:</span>
        <span class="n">input_uncompressed</span> <span class="o">=</span> <span class="n">input_fastq</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gzip -d </span><span class="si">{</span><span class="n">input_fastq</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">input_uncompressed</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">input_fastq</span> <span class="o">=</span> <span class="n">input_uncompressed</span>

    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sed -n &#39;1~4s/^@/&gt;/p;2~4p&#39; </span><span class="si">{</span><span class="n">input_fastq</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">output_fasta</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.is_legit_dn_asequence" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_legit_dn_asequence</span><span class="p">(</span><span class="n">record_seq</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Assert that DNA sequence only contains valid symbols</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_legit_dn_asequence</span><span class="p">(</span><span class="n">record_seq</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assert that DNA sequence only contains valid symbols</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">}</span>
    <span class="n">seq_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">record_seq</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">seq_symbols</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.is_legit_peptide_sequence" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_legit_peptide_sequence</span><span class="p">(</span><span class="n">record_seq</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Assert that peptide sequence only contains valid symbols</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_legit_peptide_sequence</span><span class="p">(</span><span class="n">record_seq</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assert that peptide sequence only contains valid symbols</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aas</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C&quot;</span><span class="p">,</span>
        <span class="s2">&quot;D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;E&quot;</span><span class="p">,</span>
        <span class="s2">&quot;F&quot;</span><span class="p">,</span>
        <span class="s2">&quot;G&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I&quot;</span><span class="p">,</span>
        <span class="s2">&quot;K&quot;</span><span class="p">,</span>
        <span class="s2">&quot;L&quot;</span><span class="p">,</span>
        <span class="s2">&quot;M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
        <span class="s2">&quot;R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;S&quot;</span><span class="p">,</span>
        <span class="s2">&quot;T&quot;</span><span class="p">,</span>
        <span class="s2">&quot;V&quot;</span><span class="p">,</span>
        <span class="s2">&quot;W&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">seq_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">record_seq</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">seq_symbols</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">aas</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.merge_fastas" class="doc doc-heading">
<code class="highlight language-python"><span class="n">merge_fastas</span><span class="p">(</span><span class="n">input_fastas_dir</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Merge input fasta files into a single fasta</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">merge_fastas</span><span class="p">(</span><span class="n">input_fastas_dir</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge input fasta files into a single fasta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_fastas_dir</span><span class="p">,</span> <span class="s2">&quot;merged.fasta&quot;</span><span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_fasta</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;awk 1 * &gt; </span><span class="si">{</span><span class="n">output_fasta</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="n">input_fastas_dir</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.remove_duplicates_from_fasta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remove_duplicates_from_fasta</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">duplicates_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;seqkit&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Removes duplicate entries (either by sequence or ID) from fasta.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@handle_exceptions</span>
<span class="k">def</span> <span class="nf">remove_duplicates_from_fasta</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">export_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">duplicates_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;seqkit&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes duplicate entries (either by sequence or ID) from fasta.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;_noduplicates&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">export_duplicates</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;seqkit&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;export_duplicates is only supported by method: seqkit&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;bio&quot;</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
        <span class="n">seen_seqs</span><span class="p">,</span> <span class="n">seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">unique_records</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">seq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_seqs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">):</span>
                    <span class="n">seen_seqs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
                    <span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">record</span>

        <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">unique_records</span><span class="p">(),</span> <span class="n">output_fasta</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">duplicates_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duplicates_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
                <span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;_duplicates&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span>
            <span class="p">)</span>
        <span class="n">wrappers</span><span class="o">.</span><span class="n">run_seqkit_nodup</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_fasta</span><span class="p">,</span>
            <span class="n">output_fasta</span><span class="o">=</span><span class="n">output_fasta</span><span class="p">,</span>
            <span class="n">export_duplicates</span><span class="o">=</span><span class="n">export_duplicates</span><span class="p">,</span>
            <span class="n">duplicates_file</span><span class="o">=</span><span class="n">duplicates_file</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.set_original_record_ids_in_fasta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_original_record_ids_in_fasta</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">label_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Relabel temporary record ID by original IDs</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_original_record_ids_in_fasta</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Relabel temporary record ID by original IDs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_original_ids&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">relabel_records</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">label_dict</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">record</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">yield</span> <span class="n">record</span>

    <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">relabel_records</span><span class="p">(),</span> <span class="n">output_fasta</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.set_temp_record_ids_in_fasta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_temp_record_ids_in_fasta</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Change record ids for numbers and store then in a dictionary</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_temp_record_ids_in_fasta</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change record ids for numbers and store then in a dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix_str</span> <span class="o">=</span> <span class="n">prefix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">fasta_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
        <span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_short_ids&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">dict_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
        <span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_id_dict&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.pickle&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">output_fasta</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">fasta_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">output_dict</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dict_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">fasta</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">)</span>
    <span class="n">id_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_fasta</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfasta</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fasta</span><span class="p">):</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix_str</span><span class="si">}{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">id_dict</span><span class="p">[</span><span class="n">new_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">description</span>
            <span class="n">outfasta</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">new_id</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">save_to_pickle_file</span><span class="p">(</span><span class="n">id_dict</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.preprocessing.write_record_names_to_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write_record_names_to_file</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">filter_by_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Write a txt file containing a list of record IDs in fasta
@params:
filter_by_tag: set to str containing a pattern to match
in record labels. In this case, only matched record labels
are returned.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/preprocessing.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_record_names_to_file</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filter_by_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a txt file containing a list of record IDs in fasta</span>
<span class="sd">    @params:</span>
<span class="sd">    filter_by_tag: set to str containing a pattern to match</span>
<span class="sd">    in record labels. In this case, only matched record labels</span>
<span class="sd">    are returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filter_by_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">filter_by_tag</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;grep &#39;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2"> | cut -c 2- &gt; </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-databasemanipulation">Module database.manipulation</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.database.manipulation"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to create peptide-specific sequence databases</p>
<ol>
<li>Implement hmmr</li>
<li>Filter fasta files based on query sequences</li>
</ol>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.database.manipulation.LinkedHMMfilter" class="doc doc-heading">
        <code>LinkedHMMfilter</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Tools to search for linkage structures among sets of hmm models</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LinkedHMMfilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tools to search for linkage structures among sets of hmm models</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmm_hits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for contigs that satisfy the given gene linkage structure</span>

<span class="sd">        @param: hmm_hits, a dict of pandas DataFrames, as output by</span>
<span class="sd">                parse_hmmsearch_output with keys corresponding to hmm names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hmm_hits</span> <span class="o">=</span> <span class="n">hmm_hits</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_linkage_string</span><span class="p">(</span><span class="n">link_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse linkage structure string. A linkage structure</span>
<span class="sd">        is a string like the following:</span>

<span class="sd">        &gt;hmm_a n_ab &lt;hmm_b n_bc hmm_c</span>

<span class="sd">        where &#39;&gt;&#39; indicates a hmm target located on the positive strand,</span>
<span class="sd">        &#39;&lt;&#39; a target located on the negative strand, and n_ab cooresponds</span>
<span class="sd">        to the maximum number of genes separating matched gene a and b.</span>
<span class="sd">        Multiple hmms may be employed (limited by computational capabilities).</span>
<span class="sd">        No order symbol in a hmm indicates that results should be independent</span>
<span class="sd">        of strand location.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">split_strand_from_locus</span><span class="p">(</span><span class="n">locus_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">or</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
                <span class="n">sense</span> <span class="o">=</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">locus_str</span> <span class="o">=</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">strand</span> <span class="o">=</span> <span class="s2">&quot;pos&quot;</span> <span class="k">if</span> <span class="n">sense</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">else</span> <span class="s2">&quot;neg&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strand</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">strand</span><span class="p">,</span> <span class="n">locus_str</span><span class="p">)</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">link_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">max_dists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">hmms</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">hmms</span><span class="p">,</span> <span class="n">hmms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">parsed_struc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">max_dists</span><span class="p">):</span>
            <span class="n">sense_a</span><span class="p">,</span> <span class="n">locus_a</span> <span class="o">=</span> <span class="n">split_strand_from_locus</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sense_b</span><span class="p">,</span> <span class="n">locus_b</span> <span class="o">=</span> <span class="n">split_strand_from_locus</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">parsed_struc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">locus_a</span><span class="p">,</span> <span class="n">locus_b</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">sense_a</span><span class="p">,</span> <span class="n">sense_b</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">parsed_struc</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filter_hits_by_linkage_pair</span><span class="p">(</span>
        <span class="n">hit_labels_a</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">hit_labels_b</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">dist_ab</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">strand_a</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">strand_b</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get labels compatible with linked pair</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">in_right_strand</span><span class="p">(</span><span class="n">hit_strand</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strand</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hit_strand</span> <span class="o">==</span> <span class="n">strand</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">get_linked_hit_labels_with_strand</span><span class="p">():</span>
            <span class="n">linked_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">hit_labels_a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hit_a</span> <span class="ow">in</span> <span class="n">hit_labels_a</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">in_right_strand</span><span class="p">(</span><span class="n">hit_a</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">linked_labels</span>
                <span class="p">):</span>
                    <span class="n">contig_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">contig</span>
                    <span class="n">pos_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">gene_pos</span>
                    <span class="n">linked_b_hits</span> <span class="o">=</span> <span class="n">hit_labels_b</span><span class="p">[</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">contig</span> <span class="o">==</span> <span class="n">contig_a</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">gene_pos</span> <span class="o">-</span> <span class="n">pos_a</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dist_ab</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand_b</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">linked_b_labels</span> <span class="o">=</span> <span class="n">linked_b_hits</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">linked_b_labels</span><span class="p">:</span>
                        <span class="n">linked_labels</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">hit_a</span><span class="o">.</span><span class="n">full</span><span class="p">]</span> <span class="o">+</span> <span class="n">linked_b_labels</span><span class="p">)</span>
                        <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">linked_b_hits</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit_a</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_linked_hit_labels</span><span class="p">():</span>
            <span class="n">linked_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">hit_labels_a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hit_a</span> <span class="ow">in</span> <span class="n">hit_labels_a</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">linked_labels</span><span class="p">:</span>
                    <span class="n">contig_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">contig</span>
                    <span class="n">pos_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">gene_pos</span>
                    <span class="n">linked_b_hits</span> <span class="o">=</span> <span class="n">hit_labels_b</span><span class="p">[</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">contig</span> <span class="o">==</span> <span class="n">contig_a</span><span class="p">)</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">gene_pos</span> <span class="o">-</span> <span class="n">pos_a</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dist_ab</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">linked_b_labels</span> <span class="o">=</span> <span class="n">linked_b_hits</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">linked_b_labels</span><span class="p">:</span>
                        <span class="n">linked_labels</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">hit_a</span><span class="o">.</span><span class="n">full</span><span class="p">]</span> <span class="o">+</span> <span class="n">linked_b_labels</span><span class="p">)</span>
                        <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">linked_b_hits</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit_a</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">strand_a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">strand_b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_linked_hit_labels</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_linked_hit_labels_with_strand</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">filter_hits_by_linked_hmm_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_structure</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for contigs that satisfy the given gene linkage structure</span>
<span class="sd">        @param: link_structure, a str describing the desired linkage structure,</span>
<span class="sd">                structured as follows:</span>

<span class="sd">                &#39;hmm_a N_ab hmm_b&#39;</span>

<span class="sd">                where N_ab corresponds to the maximum number of genes separating</span>
<span class="sd">                gene found by hmm_a and gene found by hmm_b, and hmm_ corresponds</span>
<span class="sd">                to the name of the hmm as provided in the keys of hmm_hits.</span>
<span class="sd">                More than two hmms can be concatenated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parsed_struc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_linkage_string</span><span class="p">(</span><span class="n">link_structure</span><span class="p">)</span>

        <span class="n">hit_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mardblabel</span> <span class="o">=</span> <span class="n">MARdbLabelParser</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">hmm</span><span class="p">,</span> <span class="n">hits</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmm_hits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No records found in database matching HMM: </span><span class="si">{</span><span class="n">hmm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">hit_labels</span><span class="p">[</span><span class="n">hmm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mardblabel</span><span class="o">.</span><span class="n">parse_from_list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">linked_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_struc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">locus_a</span><span class="p">,</span> <span class="n">locus_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span> <span class="o">=</span> <span class="n">linked_pair</span>
                <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span> <span class="o">=</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">locus_a</span><span class="p">),</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                    <span class="n">locus_b</span>
                <span class="p">)</span>
                <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_hits_by_linkage_pair</span><span class="p">(</span>
                    <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">locus_a</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">locus_a</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">locus_b</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">new_locus_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span> <span class="o">=</span> <span class="n">linked_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">hit_labels</span><span class="p">[</span><span class="n">locus_a</span><span class="p">]</span> <span class="o">=</span> <span class="n">linked_hit_labels</span>
                <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span> <span class="o">=</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">locus_a</span><span class="p">),</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                    <span class="n">new_locus_b</span>
                <span class="p">)</span>
                <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_hits_by_linkage_pair</span><span class="p">(</span>
                    <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">linked_hit_labels</span>

    <span class="k">def</span> <span class="nf">partition_linked_labels_by_hmm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">linked_hit_labels</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Partition linked labels dataframe into several dataframes containing</span>
<span class="sd">        hmm-specific hits.  This is a workaround to avoid extensive modification of</span>
<span class="sd">        LinkedHMMfilter.filter_hits_by_linked_hmm_structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">hmm_name</span><span class="p">:</span> <span class="n">linked_hit_labels</span><span class="p">[</span><span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">hmm_name</span><span class="p">,</span> <span class="n">hits</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmm_hits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.manipulation.LinkedHMMfilter.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">hmm_hits</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Search for contigs that satisfy the given gene linkage structure</p>
<p>@param: hmm_hits, a dict of pandas DataFrames, as output by
        parse_hmmsearch_output with keys corresponding to hmm names</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmm_hits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for contigs that satisfy the given gene linkage structure</span>

<span class="sd">    @param: hmm_hits, a dict of pandas DataFrames, as output by</span>
<span class="sd">            parse_hmmsearch_output with keys corresponding to hmm names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_hmm_hits</span> <span class="o">=</span> <span class="n">hmm_hits</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.manipulation.LinkedHMMfilter.filter_hits_by_linkage_pair" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_hits_by_linkage_pair</span><span class="p">(</span><span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strand_b</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get labels compatible with linked pair</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">filter_hits_by_linkage_pair</span><span class="p">(</span>
    <span class="n">hit_labels_a</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">hit_labels_b</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dist_ab</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">strand_a</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">strand_b</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get labels compatible with linked pair</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">in_right_strand</span><span class="p">(</span><span class="n">hit_strand</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strand</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hit_strand</span> <span class="o">==</span> <span class="n">strand</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_linked_hit_labels_with_strand</span><span class="p">():</span>
        <span class="n">linked_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">hit_labels_a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hit_a</span> <span class="ow">in</span> <span class="n">hit_labels_a</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">in_right_strand</span><span class="p">(</span><span class="n">hit_a</span><span class="o">.</span><span class="n">strand</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">linked_labels</span>
            <span class="p">):</span>
                <span class="n">contig_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">contig</span>
                <span class="n">pos_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">gene_pos</span>
                <span class="n">linked_b_hits</span> <span class="o">=</span> <span class="n">hit_labels_b</span><span class="p">[</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">contig</span> <span class="o">==</span> <span class="n">contig_a</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">gene_pos</span> <span class="o">-</span> <span class="n">pos_a</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dist_ab</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">strand</span> <span class="o">==</span> <span class="n">strand_b</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="n">linked_b_labels</span> <span class="o">=</span> <span class="n">linked_b_hits</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">linked_b_labels</span><span class="p">:</span>
                    <span class="n">linked_labels</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">hit_a</span><span class="o">.</span><span class="n">full</span><span class="p">]</span> <span class="o">+</span> <span class="n">linked_b_labels</span><span class="p">)</span>
                    <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">linked_b_hits</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit_a</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_linked_hit_labels</span><span class="p">():</span>
        <span class="n">linked_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">hit_labels_a</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hit_a</span> <span class="ow">in</span> <span class="n">hit_labels_a</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">full</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">linked_labels</span><span class="p">:</span>
                <span class="n">contig_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">contig</span>
                <span class="n">pos_a</span> <span class="o">=</span> <span class="n">hit_a</span><span class="o">.</span><span class="n">gene_pos</span>
                <span class="n">linked_b_hits</span> <span class="o">=</span> <span class="n">hit_labels_b</span><span class="p">[</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">contig</span> <span class="o">==</span> <span class="n">contig_a</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">hit_labels_b</span><span class="o">.</span><span class="n">gene_pos</span> <span class="o">-</span> <span class="n">pos_a</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dist_ab</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="n">linked_b_labels</span> <span class="o">=</span> <span class="n">linked_b_hits</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">linked_b_labels</span><span class="p">:</span>
                    <span class="n">linked_labels</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">hit_a</span><span class="o">.</span><span class="n">full</span><span class="p">]</span> <span class="o">+</span> <span class="n">linked_b_labels</span><span class="p">)</span>
                    <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">linked_b_hits</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hit_a</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">strand_a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">strand_b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_linked_hit_labels</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_linked_hit_labels_with_strand</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.manipulation.LinkedHMMfilter.filter_hits_by_linked_hmm_structure" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_hits_by_linked_hmm_structure</span><span class="p">(</span><span class="n">link_structure</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Search for contigs that satisfy the given gene linkage structure
@param: link_structure, a str describing the desired linkage structure,
        structured as follows:</p>
<pre><code>    'hmm_a N_ab hmm_b'

    where N_ab corresponds to the maximum number of genes separating
    gene found by hmm_a and gene found by hmm_b, and hmm_ corresponds
    to the name of the hmm as provided in the keys of hmm_hits.
    More than two hmms can be concatenated.
</code></pre>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_hits_by_linked_hmm_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_structure</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for contigs that satisfy the given gene linkage structure</span>
<span class="sd">    @param: link_structure, a str describing the desired linkage structure,</span>
<span class="sd">            structured as follows:</span>

<span class="sd">            &#39;hmm_a N_ab hmm_b&#39;</span>

<span class="sd">            where N_ab corresponds to the maximum number of genes separating</span>
<span class="sd">            gene found by hmm_a and gene found by hmm_b, and hmm_ corresponds</span>
<span class="sd">            to the name of the hmm as provided in the keys of hmm_hits.</span>
<span class="sd">            More than two hmms can be concatenated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parsed_struc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_linkage_string</span><span class="p">(</span><span class="n">link_structure</span><span class="p">)</span>

    <span class="n">hit_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mardblabel</span> <span class="o">=</span> <span class="n">MARdbLabelParser</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">hmm</span><span class="p">,</span> <span class="n">hits</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmm_hits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No records found in database matching HMM: </span><span class="si">{</span><span class="n">hmm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hit_labels</span><span class="p">[</span><span class="n">hmm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mardblabel</span><span class="o">.</span><span class="n">parse_from_list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">linked_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_struc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">locus_a</span><span class="p">,</span> <span class="n">locus_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span> <span class="o">=</span> <span class="n">linked_pair</span>
            <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span> <span class="o">=</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">locus_a</span><span class="p">),</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                <span class="n">locus_b</span>
            <span class="p">)</span>
            <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_hits_by_linkage_pair</span><span class="p">(</span>
                <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">locus_a</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">locus_a</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">locus_b</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">new_locus_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span> <span class="o">=</span> <span class="n">linked_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">hit_labels</span><span class="p">[</span><span class="n">locus_a</span><span class="p">]</span> <span class="o">=</span> <span class="n">linked_hit_labels</span>
            <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span> <span class="o">=</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">locus_a</span><span class="p">),</span> <span class="n">hit_labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                <span class="n">new_locus_b</span>
            <span class="p">)</span>
            <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_hits_by_linkage_pair</span><span class="p">(</span>
                <span class="n">hit_labels_a</span><span class="p">,</span> <span class="n">hit_labels_b</span><span class="p">,</span> <span class="n">dist_ab</span><span class="p">,</span> <span class="n">strand_a</span><span class="p">,</span> <span class="n">strand_b</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">linked_hit_labels</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.manipulation.LinkedHMMfilter.parse_linkage_string" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_linkage_string</span><span class="p">(</span><span class="n">link_str</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse linkage structure string. A linkage structure
is a string like the following:</p>
<blockquote>
<p>hmm_a n_ab &lt;hmm_b n_bc hmm_c</p>
</blockquote>
<p>where '&gt;' indicates a hmm target located on the positive strand,
'&lt;' a target located on the negative strand, and n_ab cooresponds
to the maximum number of genes separating matched gene a and b.
Multiple hmms may be employed (limited by computational capabilities).
No order symbol in a hmm indicates that results should be independent
of strand location.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">parse_linkage_string</span><span class="p">(</span><span class="n">link_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse linkage structure string. A linkage structure</span>
<span class="sd">    is a string like the following:</span>

<span class="sd">    &gt;hmm_a n_ab &lt;hmm_b n_bc hmm_c</span>

<span class="sd">    where &#39;&gt;&#39; indicates a hmm target located on the positive strand,</span>
<span class="sd">    &#39;&lt;&#39; a target located on the negative strand, and n_ab cooresponds</span>
<span class="sd">    to the maximum number of genes separating matched gene a and b.</span>
<span class="sd">    Multiple hmms may be employed (limited by computational capabilities).</span>
<span class="sd">    No order symbol in a hmm indicates that results should be independent</span>
<span class="sd">    of strand location.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">split_strand_from_locus</span><span class="p">(</span><span class="n">locus_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">or</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
            <span class="n">sense</span> <span class="o">=</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">locus_str</span> <span class="o">=</span> <span class="n">locus_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="s2">&quot;pos&quot;</span> <span class="k">if</span> <span class="n">sense</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">else</span> <span class="s2">&quot;neg&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">strand</span><span class="p">,</span> <span class="n">locus_str</span><span class="p">)</span>

    <span class="n">links</span> <span class="o">=</span> <span class="n">link_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">max_dists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
    <span class="n">hmms</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">links</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">hmms</span><span class="p">,</span> <span class="n">hmms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">parsed_struc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">max_dists</span><span class="p">):</span>
        <span class="n">sense_a</span><span class="p">,</span> <span class="n">locus_a</span> <span class="o">=</span> <span class="n">split_strand_from_locus</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sense_b</span><span class="p">,</span> <span class="n">locus_b</span> <span class="o">=</span> <span class="n">split_strand_from_locus</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">parsed_struc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">locus_a</span><span class="p">,</span> <span class="n">locus_b</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">sense_a</span><span class="p">,</span> <span class="n">sense_b</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">parsed_struc</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.manipulation.LinkedHMMfilter.partition_linked_labels_by_hmm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">partition_linked_labels_by_hmm</span><span class="p">(</span><span class="n">linked_hit_labels</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Partition linked labels dataframe into several dataframes containing
hmm-specific hits.  This is a workaround to avoid extensive modification of
LinkedHMMfilter.filter_hits_by_linked_hmm_structure.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">partition_linked_labels_by_hmm</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">linked_hit_labels</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partition linked labels dataframe into several dataframes containing</span>
<span class="sd">    hmm-specific hits.  This is a workaround to avoid extensive modification of</span>
<span class="sd">    LinkedHMMfilter.filter_hits_by_linked_hmm_structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">hmm_name</span><span class="p">:</span> <span class="n">linked_hit_labels</span><span class="p">[</span><span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">hmm_name</span><span class="p">,</span> <span class="n">hits</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmm_hits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.convert_fasta_aln_to_phylip" class="doc doc-heading">
<code class="highlight language-python"><span class="n">convert_fasta_aln_to_phylip</span><span class="p">(</span><span class="n">input_fasta_aln</span><span class="p">,</span> <span class="n">output_phylip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert alignments in Fasta to Phylip.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convert_fasta_aln_to_phylip</span><span class="p">(</span>
    <span class="n">input_fasta_aln</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_phylip</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert alignments in Fasta to Phylip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_phylip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_phylip</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta_aln</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.phylip&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_fasta_aln</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_handle</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span>
        <span class="n">output_phylip</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">output_handle</span><span class="p">:</span>
        <span class="n">alignments</span> <span class="o">=</span> <span class="n">AlignIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_handle</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">)</span>
        <span class="n">AlignIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">output_handle</span><span class="p">,</span> <span class="s2">&quot;phylip-relaxed&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.convert_phylip_to_fasta_aln" class="doc doc-heading">
<code class="highlight language-python"><span class="n">convert_phylip_to_fasta_aln</span><span class="p">(</span><span class="n">input_phylip</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert alignments in Phylip to Fasta format</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convert_phylip_to_fasta_aln</span><span class="p">(</span><span class="n">input_phylip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert alignments in Phylip to Fasta format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_phylip</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.faln&quot;</span><span class="p">)</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">AlignIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">input_phylip</span><span class="p">,</span> <span class="s2">&quot;phylip-relaxed&quot;</span><span class="p">)</span>
    <span class="n">AlignIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.convert_stockholm_to_fasta_aln" class="doc doc-heading">
<code class="highlight language-python"><span class="n">convert_stockholm_to_fasta_aln</span><span class="p">(</span><span class="n">input_stockholm</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert alignment file in Stockholm format to fasta</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">convert_stockholm_to_fasta_aln</span><span class="p">(</span>
    <span class="n">input_stockholm</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert alignment file in Stockholm format to fasta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_stockholm</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.faln&quot;</span><span class="p">)</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">AlignIO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">input_stockholm</span><span class="p">,</span> <span class="s2">&quot;stockholm&quot;</span><span class="p">)</span>
    <span class="n">AlignIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.count_records_in_fasta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">count_records_in_fasta</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Count records in fasta file</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">count_records_in_fasta</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count records in fasta file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">n_records</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">n_records</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.filter_fasta_by_hmm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_fasta_by_hmm</span><span class="p">(</span><span class="n">hmm_model</span><span class="p">,</span> <span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hmmer_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hmmsearch&#39;</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Generate protein-specific database by filtering
sequence database to only contain sequences
corresponing to protein of interest</p>
<p>@Arguments:
additional_args: additional arguments to hmmsearch or hmmscan</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_fasta_by_hmm</span><span class="p">(</span>
    <span class="n">hmm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hmmer_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hmmsearch&quot;</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate protein-specific database by filtering</span>
<span class="sd">    sequence database to only contain sequences</span>
<span class="sd">    corresponing to protein of interest</span>

<span class="sd">    @Arguments:</span>
<span class="sd">    additional_args: additional arguments to hmmsearch or hmmscan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hmm_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">hmm_model</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">hmmer_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hmmer_output</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">hmm_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;filtered_</span><span class="si">{</span><span class="n">hmm_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Hmmer...&quot;</span><span class="p">)</span>
    <span class="n">wrappers</span><span class="o">.</span><span class="n">run_hmmsearch</span><span class="p">(</span>
        <span class="n">hmm_model</span><span class="o">=</span><span class="n">hmm_model</span><span class="p">,</span>
        <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_fasta</span><span class="p">,</span>
        <span class="n">output_file</span><span class="o">=</span><span class="n">hmmer_output</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing Hmmer output file...&quot;</span><span class="p">)</span>
    <span class="n">hmmer_hits</span> <span class="o">=</span> <span class="n">parse_hmmsearch_output</span><span class="p">(</span><span class="n">hmmer_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hmmer_hits</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No records found in database matching provided hmm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering Fasta...&quot;</span><span class="p">)</span>
    <span class="n">filter_fasta_by_ids</span><span class="p">(</span>
        <span class="n">input_fasta</span><span class="p">,</span> <span class="n">record_ids</span><span class="o">=</span><span class="n">hmmer_hits</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="n">output_fasta</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.filter_fasta_by_hmm_structure" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_fasta_by_hmm_structure</span><span class="p">(</span><span class="n">hmm_structure</span><span class="p">,</span> <span class="n">target_hmm</span><span class="p">,</span> <span class="n">input_fasta</span><span class="p">,</span> <span class="n">input_hmms</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hmmer_output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reuse_hmmer_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hmmsearch&#39;</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Generate protein-specific database by filtering sequence database
to only contain sequences which satisfy the provided (gene/hmm)
structure</p>
<p>@Arguments:
additional_args: additional arguments to hmmsearch or hmmscan. Each
element in the list is a string with additional arguments for each
input hmm (arranged in the same order), an element can also take a
value of None to avoid passing additional arguments for a specific
input hmm. A single string may also be passed, in which case the
same additional argument is passed to hmmsearch for all input hmms</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_fasta_by_hmm_structure</span><span class="p">(</span>
    <span class="n">hmm_structure</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">target_hmm</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_hmms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hmmer_output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reuse_hmmer_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hmmsearch&quot;</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate protein-specific database by filtering sequence database</span>
<span class="sd">    to only contain sequences which satisfy the provided (gene/hmm)</span>
<span class="sd">    structure</span>

<span class="sd">    @Arguments:</span>
<span class="sd">    additional_args: additional arguments to hmmsearch or hmmscan. Each</span>
<span class="sd">    element in the list is a string with additional arguments for each</span>
<span class="sd">    input hmm (arranged in the same order), an element can also take a</span>
<span class="sd">    value of None to avoid passing additional arguments for a specific</span>
<span class="sd">    input hmm. A single string may also be passed, in which case the</span>
<span class="sd">    same additional argument is passed to hmmsearch for all input hmms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;filtered_</span><span class="si">{</span><span class="n">hmm_structure</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">hmmer_output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hmmer_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s2">&quot;hmmer_outputs&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">input_hmms</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">additional_args</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_args</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">input_hmms</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">additional_args</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">additional_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">input_hmms</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additional_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additional_args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_hmms</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Provided additional argument strings are less than the number of input hmms.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Additional arguments must be: 1) a list[str], 2) a str, or 3) None&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">hmmer_output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">hmmer_output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Hmmer...&quot;</span><span class="p">)</span>
    <span class="n">hmm_hits</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">hmm_model</span><span class="p">,</span> <span class="n">add_args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_hmms</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">):</span>
        <span class="n">hmm_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">hmm_model</span><span class="p">))</span>
        <span class="n">hmmer_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hmmer_output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;hmmer_output_</span><span class="si">{</span><span class="n">hmm_name</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">reuse_hmmer_results</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">hmmer_output</span><span class="p">)):</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">run_hmmsearch</span><span class="p">(</span>
                <span class="n">hmm_model</span><span class="o">=</span><span class="n">hmm_model</span><span class="p">,</span>
                <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_fasta</span><span class="p">,</span>
                <span class="n">output_file</span><span class="o">=</span><span class="n">hmmer_output</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">additional_args</span><span class="o">=</span><span class="n">add_args</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">hmm_hits</span><span class="p">[</span><span class="n">hmm_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_hmmsearch_output</span><span class="p">(</span><span class="n">hmmer_output</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering results by HMM structure...&quot;</span><span class="p">)</span>
    <span class="n">linkedfilter</span> <span class="o">=</span> <span class="n">LinkedHMMfilter</span><span class="p">(</span><span class="n">hmm_hits</span><span class="p">)</span>
    <span class="n">linked_hit_labels</span> <span class="o">=</span> <span class="n">linkedfilter</span><span class="o">.</span><span class="n">filter_hits_by_linked_hmm_structure</span><span class="p">(</span><span class="n">hmm_structure</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">linked_hit_labels</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No records found in database matching provided hmm structure&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering Fasta...&quot;</span><span class="p">)</span>
    <span class="n">partitioned_hit_labels</span> <span class="o">=</span> <span class="n">linkedfilter</span><span class="o">.</span><span class="n">partition_linked_labels_by_hmm</span><span class="p">(</span>
        <span class="n">linked_hit_labels</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">hmm_name</span> <span class="ow">in</span> <span class="n">hmm_hits</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hmm_name</span> <span class="ow">in</span> <span class="n">target_hmm</span><span class="p">:</span>
            <span class="n">outfasta</span> <span class="o">=</span> <span class="n">output_fasta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hmm_name</span><span class="si">}</span><span class="s2">_hits.fasta&quot;</span><span class="p">)</span>
        <span class="n">record_ids</span> <span class="o">=</span> <span class="n">partitioned_hit_labels</span><span class="p">[</span><span class="n">hmm_name</span><span class="p">]</span><span class="o">.</span><span class="n">full</span><span class="o">.</span><span class="n">values</span>
        <span class="n">filter_fasta_by_ids</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">record_ids</span><span class="o">=</span><span class="n">record_ids</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="n">outfasta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.filter_fasta_by_ids" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_fasta_by_ids</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">record_ids</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Filter records in fasta file matching provided IDs</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_fasta_by_ids</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">record_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter records in fasta file matching provided IDs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;_fitered&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_fasta</span> <span class="o">+</span> <span class="s2">&quot;.fxi&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">input_fasta</span> <span class="o">+</span> <span class="s2">&quot;.fxi&quot;</span><span class="p">)</span>
    <span class="n">record_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">record_ids</span><span class="p">)</span>

    <span class="c1"># fa = pyfastx.Fasta(input_fasta)</span>
    <span class="c1"># with open(output_fasta, &quot;w&quot;) as fp:</span>
    <span class="c1">#     for record_id in record_ids:</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             record_obj = fa[record_id]</span>
    <span class="c1">#             fp.write(record_obj.raw)</span>
    <span class="c1">#         except Exception:</span>
    <span class="c1">#             pass</span>
    <span class="c1"># os.remove(input_fasta + &quot;.fxi&quot;)</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w+t&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_ids</span><span class="p">:</span>
        <span class="n">tmp_ids</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">record_ids</span><span class="p">))</span>
        <span class="n">tmp_ids</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">tmp_ids_path</span> <span class="o">=</span> <span class="n">tmp_ids</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;seqkit grep -i -f </span><span class="si">{</span><span class="n">tmp_ids_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">output_fasta</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.filter_fasta_by_sequence_length" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_fasta_by_sequence_length</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Filter sequences by length in fasta file</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_fasta_by_sequence_length</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">min_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter sequences by length in fasta file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">min_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">max_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Missing boundary values for sequence length&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">input_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="n">fa</span> <span class="o">=</span> <span class="n">pyfastx</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="n">record_ids</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">min_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_length</span><span class="p">)</span>
        <span class="n">record_ids</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">record_ids</span> <span class="o">&gt;=</span> <span class="n">min_length</span><span class="p">,</span> <span class="n">record_ids</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">record_ids</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">record_ids</span> <span class="o">&gt;=</span> <span class="n">min_length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_length_</span><span class="si">{</span><span class="n">min_length</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">max_tag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">record_ids</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No records found with given sequence length bounds&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_fasta</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">record_ids</span><span class="p">:</span>
            <span class="n">record_obj</span> <span class="o">=</span> <span class="n">fa</span><span class="p">[</span><span class="n">record_id</span><span class="p">]</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">record_obj</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">input_fasta</span> <span class="o">+</span> <span class="s2">&quot;.fxi&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.get_fasta_record_ids" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_fasta_record_ids</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Extract record ids from fasta</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_fasta_record_ids</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract record ids from fasta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fasta</span> <span class="o">=</span> <span class="n">pyfastx</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="n">full_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">fasta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.parse_hmmsearch_output" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_hmmsearch_output</span><span class="p">(</span><span class="n">hmmer_output</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parse hmmsearch or hmmscan summary table output file</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_hmmsearch_output</span><span class="p">(</span><span class="n">hmmer_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse hmmsearch or hmmscan summary table output file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attribs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">,</span> <span class="s2">&quot;bitscore&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">]</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hmmer_output</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">queryresult</span> <span class="ow">in</span> <span class="n">SearchIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;hmmer3-tab&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">queryresult</span><span class="o">.</span><span class="n">hits</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">attribs</span><span class="p">:</span>
                    <span class="n">hits</span><span class="p">[</span><span class="n">attrib</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hit</span><span class="p">,</span> <span class="n">attrib</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.remove_records_from_fasta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remove_records_from_fasta</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">record_ids</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Remove records from Fasta file based on provided list of record IDs.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remove_records_from_fasta</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">record_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove records from Fasta file based on provided list of record IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_reduced&quot;</span><span class="p">)</span>
    <span class="n">fasta_record_ids</span> <span class="o">=</span> <span class="n">get_fasta_record_ids</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="n">records_to_keep</span> <span class="o">=</span> <span class="n">fasta_record_ids</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">record_ids</span><span class="p">)</span>
    <span class="n">filter_fasta_by_ids</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">records_to_keep</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.manipulation.split_reference_from_query_alignments" class="doc doc-heading">
<code class="highlight language-python"><span class="n">split_reference_from_query_alignments</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">,</span> <span class="n">ref_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Separate reference sequences from query sequences in msa fasta file</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/manipulation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">split_reference_from_query_alignments</span><span class="p">(</span>
    <span class="n">ref_query_msa</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ref_ids</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Separate reference sequences from query sequences in msa fasta file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_reference</span><span class="p">(</span><span class="n">record_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">record_name</span> <span class="ow">in</span> <span class="n">ref_ids</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">ref_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_reference</span><span class="p">(</span><span class="n">record_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">record_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ref_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either set of ref ids or ref prefix&quot;</span><span class="p">)</span>
    <span class="n">out_ref_msa</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_ref_fraction&quot;</span><span class="p">)</span>
    <span class="n">out_query_msa</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_query_fraction&quot;</span><span class="p">)</span>

    <span class="n">fasta</span> <span class="o">=</span> <span class="n">pyfastx</span><span class="o">.</span><span class="n">Fasta</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">,</span> <span class="n">build_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_ref_msa</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outref</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_query_msa</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outquery</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">record_name</span><span class="p">,</span> <span class="n">record_seq</span> <span class="ow">in</span> <span class="n">fasta</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_reference</span><span class="p">(</span><span class="n">record_name</span><span class="p">):</span>
                <span class="n">outref</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">record_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outquery</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">record_name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">record_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-databasereduction">Module database.reduction</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.database.reduction"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to reduce the size of the peptide-specific
reference database</p>
<p>Currently based on:
1. CD-HIT
2. Repset: https://onlinelibrary.wiley.com/doi/10.1002/prot.25461</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.reduction.get_representative_set" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_representative_set</span><span class="p">(</span><span class="n">input_seqs</span><span class="p">,</span> <span class="n">input_pi</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Runs repset.py to obtain a representative
set of size equal to max_size (or smaller if less sequences than max_size)
or an ordered list (by 'representativeness') of representative sequences
if max_size set to None.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/reduction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_representative_set</span><span class="p">(</span>
    <span class="n">input_seqs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_pi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs repset.py to obtain a representative</span>
<span class="sd">    set of size equal to max_size (or smaller if less sequences than max_size)</span>
<span class="sd">    or an ordered list (by &#39;representativeness&#39;) of representative sequences</span>
<span class="sd">    if max_size set to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_seqs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_seqs</span><span class="p">)</span>
    <span class="n">input_pi</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_pi</span><span class="p">)</span>
    <span class="n">repset_exe</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;vendor&quot;</span> <span class="o">/</span> <span class="s2">&quot;repset_min.py&quot;</span>

    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_seqs</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_repset&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">TemporaryDirectoryPath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;python </span><span class="si">{</span><span class="n">repset_exe</span><span class="si">}</span><span class="s2"> --seqs </span><span class="si">{</span><span class="n">input_seqs</span><span class="si">}</span><span class="s2"> --pi </span><span class="si">{</span><span class="n">input_pi</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--outdir </span><span class="si">{</span><span class="n">tempdir</span><span class="si">}</span><span class="s2"> --size </span><span class="si">{</span><span class="n">max_size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s2">&quot;repset.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">repset</span><span class="p">:</span>
            <span class="n">rep_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">rep_id</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">rep_id</span> <span class="ow">in</span> <span class="n">repset</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rep_ids</span><span class="p">)):</span>
        <span class="n">rep_ids</span> <span class="o">=</span> <span class="n">rep_ids</span><span class="p">[:</span><span class="n">max_size</span><span class="p">]</span>

    <span class="n">filter_fasta_by_ids</span><span class="p">(</span>
        <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_seqs</span><span class="p">,</span> <span class="n">record_ids</span><span class="o">=</span><span class="n">rep_ids</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="n">outfile</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.database.reduction.reduce_database_redundancy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reduce_database_redundancy</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cdhit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cdhit_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Reduce redundancy of peptide datatabase.
Runs cd-hit, if selected, additional arguments to cdhit
may be passed as a string (cdhit_args).
Runs repset to obtain a final database size no larger
(number of sequences) than selected maxsize.
If maxsize = None, repset is not run.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/reduction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reduce_database_redundancy</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cdhit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">maxsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cdhit_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce redundancy of peptide datatabase.</span>
<span class="sd">    Runs cd-hit, if selected, additional arguments to cdhit</span>
<span class="sd">    may be passed as a string (cdhit_args).</span>
<span class="sd">    Runs repset to obtain a final database size no larger</span>
<span class="sd">    (number of sequences) than selected maxsize.</span>
<span class="sd">    If maxsize = None, repset is not run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cdhit</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">maxsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No reduction algorithm has been selected.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_reduced&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempaln</span><span class="p">,</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempfasta</span><span class="p">,</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempfasta2</span><span class="p">,</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempident</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cdhit</span><span class="p">:</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">run_cdhit</span><span class="p">(</span>
                <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_fasta</span><span class="p">,</span>
                <span class="n">output_fasta</span><span class="o">=</span><span class="n">tempfasta</span><span class="p">,</span>
                <span class="n">additional_args</span><span class="o">=</span><span class="n">cdhit_args</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempfasta</span> <span class="o">+</span> <span class="s2">&quot;.clstr&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">tempfasta</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">maxsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">run_mafft</span><span class="p">(</span>
                <span class="n">input_fasta</span><span class="o">=</span><span class="n">tempfasta</span><span class="p">,</span>
                <span class="n">output_file</span><span class="o">=</span><span class="n">tempaln</span><span class="p">,</span>
                <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">additional_args</span><span class="o">=</span><span class="s2">&quot;--retree 1 --maxiterate 0&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">wrappers</span><span class="o">.</span><span class="n">get_percent_identity_from_msa</span><span class="p">(</span>
                <span class="n">input_msa</span><span class="o">=</span><span class="n">tempaln</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">tempident</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding representative sequences for reference database...&quot;</span><span class="p">)</span>
            <span class="n">get_representative_set</span><span class="p">(</span>
                <span class="n">input_seqs</span><span class="o">=</span><span class="n">tempfasta</span><span class="p">,</span>
                <span class="n">input_pi</span><span class="o">=</span><span class="n">tempident</span><span class="p">,</span>
                <span class="n">max_size</span><span class="o">=</span><span class="n">maxsize</span><span class="p">,</span>
                <span class="n">outfile</span><span class="o">=</span><span class="n">tempfasta2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tempfasta2</span><span class="p">,</span> <span class="n">tempfasta</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tempfasta</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-databaselabelparsers">Module database.labelparsers</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.database.labelparsers"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to parse sequence labels from different databases</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.database.labelparsers.LabelParser" class="doc doc-heading">
        <code>LabelParser</code>


</h2>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LabelParser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse labels to extract genome ID and metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_genome_id</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract genome ID from sequence label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mmp_id</span> <span class="o">=</span> <span class="n">MARdbLabelParser</span><span class="o">.</span><span class="n">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">taxid</span> <span class="o">=</span> <span class="n">UniprotLabelParser</span><span class="o">.</span><span class="n">extract_ncbi_tax_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mmp_id</span> <span class="ow">and</span> <span class="n">taxid</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Label contains conflicting genome IDs&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">mmp_id</span><span class="p">:</span>
            <span class="n">genome_id</span> <span class="o">=</span> <span class="n">mmp_id</span>
        <span class="k">elif</span> <span class="n">taxid</span><span class="p">:</span>
            <span class="n">genome_id</span> <span class="o">=</span> <span class="n">taxid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genome_id_split</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genome_id_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">genome_id</span> <span class="o">=</span> <span class="n">genome_id_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">genome_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">genome_id</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_meta_info</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse meta information from label in canonical format</span>
<span class="sd">        (i.e, contig, gene position, locus, strand)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">locus_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">gene_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">contig</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">contig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gene_pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">locus_pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;contig&quot;</span><span class="p">:</span> <span class="n">contig</span><span class="p">,</span>
            <span class="s2">&quot;gene_pos&quot;</span><span class="p">:</span> <span class="n">gene_pos</span><span class="p">,</span>
            <span class="s2">&quot;locus_pos&quot;</span><span class="p">:</span> <span class="n">locus_pos</span><span class="p">,</span>
            <span class="s2">&quot;strand&quot;</span><span class="p">:</span> <span class="n">strand</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.LabelParser.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse labels to extract genome ID and metadata</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse labels to extract genome ID and metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.LabelParser.extract_genome_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_genome_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Extract genome ID from sequence label</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">extract_genome_id</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract genome ID from sequence label</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mmp_id</span> <span class="o">=</span> <span class="n">MARdbLabelParser</span><span class="o">.</span><span class="n">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">taxid</span> <span class="o">=</span> <span class="n">UniprotLabelParser</span><span class="o">.</span><span class="n">extract_ncbi_tax_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mmp_id</span> <span class="ow">and</span> <span class="n">taxid</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Label contains conflicting genome IDs&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">mmp_id</span><span class="p">:</span>
        <span class="n">genome_id</span> <span class="o">=</span> <span class="n">mmp_id</span>
    <span class="k">elif</span> <span class="n">taxid</span><span class="p">:</span>
        <span class="n">genome_id</span> <span class="o">=</span> <span class="n">taxid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">genome_id_split</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genome_id_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">genome_id</span> <span class="o">=</span> <span class="n">genome_id_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genome_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">genome_id</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.LabelParser.parse_meta_info" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_meta_info</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse meta information from label in canonical format
(i.e, contig, gene position, locus, strand)</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">parse_meta_info</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse meta information from label in canonical format</span>
<span class="sd">    (i.e, contig, gene position, locus, strand)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">strand</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">locus_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">gene_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">contig</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">contig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gene_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">locus_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">strand</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;contig&quot;</span><span class="p">:</span> <span class="n">contig</span><span class="p">,</span>
        <span class="s2">&quot;gene_pos&quot;</span><span class="p">:</span> <span class="n">gene_pos</span><span class="p">,</span>
        <span class="s2">&quot;locus_pos&quot;</span><span class="p">:</span> <span class="n">locus_pos</span><span class="p">,</span>
        <span class="s2">&quot;strand&quot;</span><span class="p">:</span> <span class="n">strand</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.database.labelparsers.MARdbLabelParser" class="doc doc-heading">
        <code>MARdbLabelParser</code>


</h2>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MARdbLabelParser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse MARdb entry label to extract coded info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract mardb mmp id from reference label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_entry</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;_MMP\d+&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db_entry</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse MarDB sequence labels to obtain contig and locus info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parsed_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;full&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mmp_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contig&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gene_pos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;locus_pos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;strand&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mmp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">mmp_id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">locus_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">gene_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">contig</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;mmp_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmp_id</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;contig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contig</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;gene_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_pos</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;locus_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locus_pos</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;strand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strand</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">parsed_dict</span>

    <span class="k">def</span> <span class="nf">parse_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse labels in list of labels and return DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.MARdbLabelParser.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse MARdb entry label to extract coded info</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse MARdb entry label to extract coded info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.MARdbLabelParser.extract_mmp_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Extract mardb mmp id from reference label</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract mardb mmp id from reference label</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_entry</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;_MMP\d+&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db_entry</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.MARdbLabelParser.parse" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse MarDB sequence labels to obtain contig and locus info</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse MarDB sequence labels to obtain contig and locus info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parsed_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;full&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
        <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mmp_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;contig&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gene_pos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;locus_pos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;strand&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mmp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_mmp_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">mmp_id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">strand</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">locus_pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">gene_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">contig</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span>
        <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;mmp_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmp_id</span>
        <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;contig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contig</span>
        <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;gene_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_pos</span>
        <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;locus_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locus_pos</span>
        <span class="n">parsed_dict</span><span class="p">[</span><span class="s2">&quot;strand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strand</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">parsed_dict</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.MARdbLabelParser.parse_from_list" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_from_list</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse labels in list of labels and return DataFrame</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse labels in list of labels and return DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.database.labelparsers.UniprotLabelParser" class="doc doc-heading">
        <code>UniprotLabelParser</code>


</h2>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UniprotLabelParser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse UniProt entry label to extract coded info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_ncbi_tax_id</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract NCBI taxon id from reference label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_entry</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(OX=)(\d+)&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;taxid_</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db_entry</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.UniprotLabelParser.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse UniProt entry label to extract coded info</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse UniProt entry label to extract coded info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.database.labelparsers.UniprotLabelParser.extract_ncbi_tax_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_ncbi_tax_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Extract NCBI taxon id from reference label</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/database/labelparsers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">extract_ncbi_tax_id</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract NCBI taxon id from reference label</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_entry</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(OX=)(\d+)&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;taxid_</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">db_entry</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><h2 id="module-alignment">Module alignment</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.alignment"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to perform multiple sequence alignments</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="src.metatag.alignment.align_peptides" class="doc doc-heading">
<code class="highlight language-python"><span class="n">align_peptides</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;muscle&#39;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Perform MSA on reference peptide sequences.
Outputs in format fasta.aln</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/alignment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">align_peptides</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;muscle&quot;</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform MSA on reference peptide sequences.</span>
<span class="sd">    Outputs in format fasta.aln</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.fasta.aln&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="n">input_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;muscle&quot;</span><span class="p">:</span>
        <span class="n">wrappers</span><span class="o">.</span><span class="n">run_muscle</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_fasta</span><span class="p">,</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span>
            <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;mafft&quot;</span><span class="p">:</span>
        <span class="n">wrappers</span><span class="o">.</span><span class="n">run_mafft</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="o">=</span><span class="n">input_fasta</span><span class="p">,</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span>
            <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid method. Valid methods: muscle or mafft&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.alignment.align_short_reads_to_reference_msa" class="doc doc-heading">
<code class="highlight language-python"><span class="n">align_short_reads_to_reference_msa</span><span class="p">(</span><span class="n">ref_msa</span><span class="p">,</span> <span class="n">query_seqs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;papara&#39;</span><span class="p">,</span> <span class="n">tree_nwk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Align short read query sequences to reference MSA (fasta format).
Outputs fasta msa alignment between query and reference sequences</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/alignment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">align_short_reads_to_reference_msa</span><span class="p">(</span>
    <span class="n">ref_msa</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">query_seqs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;papara&quot;</span><span class="p">,</span>
    <span class="n">tree_nwk</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align short read query sequences to reference MSA (fasta format).</span>
<span class="sd">    Outputs fasta msa alignment between query and reference sequences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ref_msa</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">ref_msa</span><span class="p">)</span>
    <span class="n">query_seqs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">query_seqs</span><span class="p">)</span>
    <span class="n">tree_nwk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">tree_nwk</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">ref_msa</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_hmm</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">ref_msa</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.hmm&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">output_aln_seqs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">query_seqs</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.faln&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;hmmalign&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_file_path</span><span class="p">:</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">run_hmmbuild</span><span class="p">(</span><span class="n">input_aln</span><span class="o">=</span><span class="n">ref_msa</span><span class="p">,</span> <span class="n">output_hmm</span><span class="o">=</span><span class="n">output_hmm</span><span class="p">)</span>

            <span class="n">wrappers</span><span class="o">.</span><span class="n">run_hmmalign</span><span class="p">(</span>
                <span class="n">input_aln</span><span class="o">=</span><span class="n">ref_msa</span><span class="p">,</span>
                <span class="n">input_hmm</span><span class="o">=</span><span class="n">output_hmm</span><span class="p">,</span>
                <span class="n">input_seqs</span><span class="o">=</span><span class="n">query_seqs</span><span class="p">,</span>
                <span class="n">output_aln_seqs</span><span class="o">=</span><span class="n">temp_file_path</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">convert_stockholm_to_fasta_aln</span><span class="p">(</span>
                <span class="n">input_stockholm</span><span class="o">=</span><span class="n">temp_file_path</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="n">output_aln_seqs</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;papara&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_phy_path</span><span class="p">,</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_aln_path</span><span class="p">:</span>
            <span class="n">convert_fasta_aln_to_phylip</span><span class="p">(</span>
                <span class="n">input_fasta_aln</span><span class="o">=</span><span class="n">ref_msa</span><span class="p">,</span> <span class="n">output_phylip</span><span class="o">=</span><span class="n">temp_phy_path</span>
            <span class="p">)</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">run_papara</span><span class="p">(</span>
                <span class="n">tree_nwk</span><span class="o">=</span><span class="n">tree_nwk</span><span class="p">,</span>
                <span class="n">msa_phy</span><span class="o">=</span><span class="n">temp_phy_path</span><span class="p">,</span>
                <span class="n">query_fasta</span><span class="o">=</span><span class="n">query_seqs</span><span class="p">,</span>
                <span class="n">output_aln</span><span class="o">=</span><span class="n">temp_aln_path</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">convert_phylip_to_fasta_aln</span><span class="p">(</span>
                <span class="n">input_phylip</span><span class="o">=</span><span class="n">temp_aln_path</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">output_aln_seqs</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Alignment method not implemented&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-phylotree">Module phylotree</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.phylotree"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to perform phylogenetic tree reconstructions and
query sequence placements onto trees</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.phylotree.PhyloTree" class="doc doc-heading">
        <code>PhyloTree</code>


</h2>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PhyloTree</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tree_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;newick&quot;</span><span class="p">,</span>
        <span class="n">bootstrap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name_internal_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methods to help defining clusters in phylo trees</span>
<span class="sd">        @params:</span>
<span class="sd">        tree: str containing either the path to the tree file or directly the tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Phylo</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">tree_format</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bootstrap_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collapse_poor_quality_nodes</span><span class="p">(</span><span class="n">bootstrap_threshold</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_internal_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_internal_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree_path</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree_format</span> <span class="o">=</span> <span class="n">tree_format</span>

    <span class="k">def</span> <span class="nf">_scale_bootstrap_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale bootstrap values to be percentages if necessary.</span>
<span class="sd">        This is to deal with discrepancies between how fasttree and</span>
<span class="sd">        iqtree report bootstrap values (fractions vs percentages)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span><span class="o">.</span><span class="n">confidence</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">find_clades</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">conf_values</span><span class="p">:</span>
            <span class="n">max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">conf_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_value</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">clade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">find_clades</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">clade</span><span class="o">.</span><span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">clade</span><span class="o">.</span><span class="n">confidence</span> <span class="o">*=</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Tree does not contain confidence values. Change tree or set bootstrap_threshold to None&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">collapse_poor_quality_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bootstrap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collapse all nodes with a bootstrap value smaller than threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_bootstrap_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">collapse_all</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">bootstrap_threshold</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">name_internal_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Give unique identifier to internal nodes</span>
<span class="sd">        including bootstrap value in identifier</span>
<span class="sd">        as: IN_n_b, where n is a unique identifying</span>
<span class="sd">        number and b the bootstrap value (or None</span>
<span class="sd">        if not present)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">clade</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_nonterminals</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">clade</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clade</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;IN_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">clade</span><span class="o">.</span><span class="n">confidence</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">clade</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_tree_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span>

    <span class="k">def</span> <span class="nf">export_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tree_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;newick&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export tree object to file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Phylo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">tree_format</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all_descendants_of_target_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all leaf names from given target (internal) node name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">find_clades</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">get_closest_common_ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get name of closest common ancestor given list of leaf names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">common_ancestor</span><span class="p">(</span><span class="n">target_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clade</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">get_all_leaf_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get list of all leaves (terminal nodes names)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">leaf</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">extract_clusters_from_internal_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract all terminal nodes which are descendants of</span>
<span class="sd">        each internal node in the tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">clade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_nonterminals</span><span class="p">():</span>
            <span class="n">terminal_nodes</span> <span class="o">=</span> <span class="n">clade</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>
            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">clade</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">terminal_nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cluster_dict</span>

    <span class="k">def</span> <span class="nf">compute_tree_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find maximum (pairwise) distance between two tips</span>
<span class="sd">        (leaves) in the tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">root</span>
        <span class="n">max_distance</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tip</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
            <span class="n">new_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">depths</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">new_max</span> <span class="o">&gt;</span> <span class="n">max_distance</span><span class="p">:</span>
                <span class="n">max_distance</span> <span class="o">=</span> <span class="n">new_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_distance</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">tree_format</span><span class="o">=</span><span class="s1">&#39;newick&#39;</span><span class="p">,</span> <span class="n">bootstrap_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_internal_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Methods to help defining clusters in phylo trees
@params:
tree: str containing either the path to the tree file or directly the tree</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">tree</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tree_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;newick&quot;</span><span class="p">,</span>
    <span class="n">bootstrap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">name_internal_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods to help defining clusters in phylo trees</span>
<span class="sd">    @params:</span>
<span class="sd">    tree: str containing either the path to the tree file or directly the tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">Phylo</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">tree_format</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">bootstrap_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collapse_poor_quality_nodes</span><span class="p">(</span><span class="n">bootstrap_threshold</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name_internal_nodes</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_internal_nodes</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tree_path</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tree_format</span> <span class="o">=</span> <span class="n">tree_format</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.collapse_poor_quality_nodes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">collapse_poor_quality_nodes</span><span class="p">(</span><span class="n">bootstrap_threshold</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Collapse all nodes with a bootstrap value smaller than threshold</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">collapse_poor_quality_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bootstrap_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collapse all nodes with a bootstrap value smaller than threshold</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scale_bootstrap_values</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">collapse_all</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">confidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&lt;</span> <span class="n">bootstrap_threshold</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.compute_tree_diameter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_tree_diameter</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Find maximum (pairwise) distance between two tips
(leaves) in the tree</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_tree_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find maximum (pairwise) distance between two tips</span>
<span class="sd">    (leaves) in the tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">root</span>
    <span class="n">max_distance</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tip</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
        <span class="n">new_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">depths</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">new_max</span> <span class="o">&gt;</span> <span class="n">max_distance</span><span class="p">:</span>
            <span class="n">max_distance</span> <span class="o">=</span> <span class="n">new_max</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">max_distance</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.export_tree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">export_tree</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">tree_format</span><span class="o">=</span><span class="s1">&#39;newick&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Export tree object to file</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">export_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tree_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;newick&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export tree object to file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Phylo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">tree_format</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.extract_clusters_from_internal_nodes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_clusters_from_internal_nodes</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Extract all terminal nodes which are descendants of
each internal node in the tree</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_clusters_from_internal_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract all terminal nodes which are descendants of</span>
<span class="sd">    each internal node in the tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">clade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_nonterminals</span><span class="p">():</span>
        <span class="n">terminal_nodes</span> <span class="o">=</span> <span class="n">clade</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>
        <span class="n">cluster_dict</span><span class="p">[</span><span class="n">clade</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">terminal_nodes</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cluster_dict</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.get_all_descendants_of_target_node" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_all_descendants_of_target_node</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get all leaf names from given target (internal) node name</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_descendants_of_target_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all leaf names from given target (internal) node name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">find_clades</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.get_all_leaf_names" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_all_leaf_names</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get list of all leaves (terminal nodes names)</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_leaf_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get list of all leaves (terminal nodes names)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">leaf</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.get_closest_common_ancestor" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_closest_common_ancestor</span><span class="p">(</span><span class="n">target_names</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get name of closest common ancestor given list of leaf names</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_closest_common_ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get name of closest common ancestor given list of leaf names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">common_ancestor</span><span class="p">(</span><span class="n">target_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clade</span><span class="o">.</span><span class="n">name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.phylotree.PhyloTree.name_internal_nodes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">name_internal_nodes</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Give unique identifier to internal nodes
including bootstrap value in identifier
as: IN_n_b, where n is a unique identifying
number and b the bootstrap value (or None
if not present)</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">name_internal_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give unique identifier to internal nodes</span>
<span class="sd">    including bootstrap value in identifier</span>
<span class="sd">    as: IN_n_b, where n is a unique identifying</span>
<span class="sd">    number and b the bootstrap value (or None</span>
<span class="sd">    if not present)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">clade</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree</span><span class="o">.</span><span class="n">get_nonterminals</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">clade</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clade</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;IN_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">clade</span><span class="o">.</span><span class="n">confidence</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">clade</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.metatag.phylotree.export_tree_clusters_to_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">export_tree_clusters_to_file</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Write tsv file containing the definition of tree clusters</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">export_tree_clusters_to_file</span><span class="p">(</span><span class="n">clusters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write tsv file containing the definition of tree clusters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_node_cluster</span><span class="p">(</span><span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cluster_name</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cluster_name</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id</span><span class="se">\t</span><span class="s2">cluster</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">node_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">nname</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">nname</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">nname</span> <span class="ow">in</span> <span class="n">node_names</span><span class="p">:</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">get_node_cluster</span><span class="p">(</span><span class="n">nname</span><span class="p">,</span> <span class="n">clusters</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nname</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.phylotree.get_iq_tree_model_from_log_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_iq_tree_model_from_log_file</span><span class="p">(</span><span class="n">iqtree_log</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parse iqtree log file and return best fit model</p>
<p>If model supplied, search model in Command: iqtree ... -m 'model'
If not, then -m TEST or -m MFP
If one of those, continue to line:
Best-fit model: 'model' chosen according to BIC</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_iq_tree_model_from_log_file</span><span class="p">(</span><span class="n">iqtree_log</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse iqtree log file and return best fit model</span>

<span class="sd">    If model supplied, search model in Command: iqtree ... -m &#39;model&#39;</span>
<span class="sd">    If not, then -m TEST or -m MFP</span>
<span class="sd">    If one of those, continue to line:</span>
<span class="sd">    Best-fit model: &#39;model&#39; chosen according to BIC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">iqtree_log</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">subtext</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(?&lt;=Command: iqtree)(.*)(?=</span><span class="se">\\</span><span class="s2">n)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(?&lt;=-m )(.*)(?= -bb)&quot;</span><span class="p">,</span> <span class="n">subtext</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mfp&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(?&lt;=Best-fit model: )(.*)(?= chosen)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.phylotree.get_tree_model_from_modeltest_log" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_tree_model_from_modeltest_log</span><span class="p">(</span><span class="n">modeltest_log</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;BIC&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parse modeltest-ng log file and return best fit model
according to selected criterion: BIC, AIC or AICc</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_tree_model_from_modeltest_log</span><span class="p">(</span>
    <span class="n">modeltest_log</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">criterion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;BIC&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse modeltest-ng log file and return best fit model</span>
<span class="sd">    according to selected criterion: BIC, AIC or AICc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">modeltest_log</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">easy_pattern_matching</span><span class="p">(</span>
            <span class="n">easy_pattern_matching</span><span class="p">(</span>
                <span class="n">text</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Best model according to </span><span class="si">{</span><span class="n">criterion</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">lnL&quot;</span>
            <span class="p">),</span>
            <span class="n">left_pattern</span><span class="o">=</span><span class="s2">&quot;Model:&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.phylotree.infer_tree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">infer_tree</span><span class="p">(</span><span class="n">ref_aln</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;iqtree&#39;</span><span class="p">,</span> <span class="n">substitution_model</span><span class="o">=</span><span class="s1">&#39;modeltest&#39;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Infer tree from reference msa. Best substitution model
selected by default.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">infer_tree</span><span class="p">(</span>
    <span class="n">ref_aln</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;iqtree&quot;</span><span class="p">,</span>
    <span class="n">substitution_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;modeltest&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Infer tree from reference msa. Best substitution model</span>
<span class="sd">    selected by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;iqtree&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;modeltest&quot;</span> <span class="ow">in</span> <span class="n">substitution_model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selecting best subsitution model per modeltest-ng...&quot;</span><span class="p">)</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">runModelTest</span><span class="p">(</span>
                <span class="n">input_algns</span><span class="o">=</span><span class="n">ref_aln</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span>
            <span class="p">)</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">get_tree_model_from_modeltest_log</span><span class="p">(</span>
                <span class="n">modeltest_log</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;modeltest_result.log&quot;</span><span class="p">),</span>
                <span class="n">criterion</span><span class="o">=</span><span class="s2">&quot;BIC&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">modeltest_starting_tree</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;modeltest_result.tree&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;iqtest&quot;</span> <span class="ow">in</span> <span class="n">substitution_model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="s2">&quot;TEST&quot;</span>
            <span class="n">modeltest_starting_tree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">substitution_model</span>
            <span class="n">modeltest_starting_tree</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">wrappers</span><span class="o">.</span><span class="n">run_iqtree</span><span class="p">(</span>
            <span class="n">input_algns</span><span class="o">=</span><span class="n">ref_aln</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">output_prefix</span><span class="o">=</span><span class="s2">&quot;ref_database&quot;</span><span class="p">,</span>
            <span class="n">keep_recovery_files</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">substitution_model</span><span class="o">=</span><span class="n">best_model</span><span class="p">,</span>
            <span class="n">starting_tree</span><span class="o">=</span><span class="n">modeltest_starting_tree</span><span class="p">,</span>
            <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;ref_database.contree&quot;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;ref_database.newick&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;fasttree&quot;</span><span class="p">:</span>
        <span class="n">wrappers</span><span class="o">.</span><span class="n">run_fasttree</span><span class="p">(</span>
            <span class="n">input_algns</span><span class="o">=</span><span class="n">ref_aln</span><span class="p">,</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;ref_database.newick&quot;</span><span class="p">),</span>
            <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong method, enter iqtree or fasttree&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.phylotree.relabel_tree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">relabel_tree</span><span class="p">(</span><span class="n">input_newick</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iTOL</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Relabel tree leaves with labels from
provided dictionary. If iTOL is set, then
labels are checked for iTOL compatibility</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">relabel_tree</span><span class="p">(</span>
    <span class="n">input_newick</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">iTOL</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Relabel tree leaves with labels from</span>
<span class="sd">    provided dictionary. If iTOL is set, then</span>
<span class="sd">    labels are checked for iTOL compatibility</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_newick</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_relabel&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iTOL</span><span class="p">:</span>
        <span class="n">sanity_check</span> <span class="o">=</span> <span class="n">sanity_check_for_iTOL</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">sanity_check</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_newick</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">sanity_check</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.phylotree.sanity_check_for_iTOL" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sanity_check_for_iTOL</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Reformat label to comply with iTOL requirements, remove:
1. white spaces
2. double underscores
3. symbols outside english letters and numbers</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/phylotree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sanity_check_for_iTOL</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformat label to comply with iTOL requirements, remove:</span>
<span class="sd">    1. white spaces</span>
<span class="sd">    2. double underscores</span>
<span class="sd">    3. symbols outside english letters and numbers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">legal_chars</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[^a-zA-Z0-9]&quot;</span><span class="p">)</span>
    <span class="n">itol_label</span> <span class="o">=</span> <span class="n">legal_chars</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">itol_label</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-placement">Module placement</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.placement"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to quantify and assign labels to placed sequences</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.placement.JplaceParser" class="doc doc-heading">
        <code>JplaceParser</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Methods to parse jplace files, as specified in
https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0031009</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/placement.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">JplaceParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods to parse jplace files, as specified in</span>
<span class="sd">    https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0031009</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_jplace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span> <span class="o">=</span> <span class="n">path_to_jplace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">Phylo</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newickfy_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">])),</span> <span class="s2">&quot;newick&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_json_object</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">JSON</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print data fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">placements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return placement objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_tree_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newick</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return tree string in original or newick format</span>
<span class="sd">        Original format contains branch labels</span>
<span class="sd">        in curly brackets. Newick format removes</span>
<span class="sd">        these labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">newick</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">newickfy_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">newickfy_tree</span><span class="p">(</span><span class="n">tree_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove branch IDs from jplace tree string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs_tree</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\{(\d+)\}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tree_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subs_tree</span>
        <span class="c1"># return next(Phylo.parse(StringIO(subs_tree), &#39;newick&#39;))</span>

    <span class="k">def</span> <span class="nf">get_reference_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get list of reference sequences in the placement tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">build_branch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build dictionary with edge/branch numbers as keys and</span>
<span class="sd">        reference tree leaves as values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;\{(\d+)\}&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">original_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">]</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>

        <span class="n">branches</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">get_id</span><span class="p">(</span><span class="n">original_tree</span><span class="p">[</span><span class="n">original_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">:]):</span> <span class="n">leaf</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">branches</span>

    <span class="k">def</span> <span class="nf">extract_placement_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pfielddata</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get dict with placement field values from list of values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">pfielddata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">select_best_placement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement_object</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select placement with lowest likelihood</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pdata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_placement_fields</span><span class="p">(</span><span class="n">pfielddata</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pfielddata</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">lowest_like_placement</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">lowest_like_placement</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">select_best_placements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select placement with lowest likelihood for</span>
<span class="sd">        all placement objects in placements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">best_placements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_best_placement</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">best_placements</span>

    <span class="k">def</span> <span class="nf">compute_tree_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find maximum (pairwise) distance between two tips</span>
<span class="sd">        (leaves) in the tree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">root</span>
        <span class="n">max_distance</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tip</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
            <span class="n">new_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">depths</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">new_max</span> <span class="o">&gt;</span> <span class="n">max_distance</span><span class="p">:</span>
                <span class="n">max_distance</span> <span class="o">=</span> <span class="n">new_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">max_distance</span>

    <span class="k">def</span> <span class="nf">filter_placements_by_minimum_lwr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">minimum_lwr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter placements by minimum LWR (from 0 to 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_min_lwr_</span><span class="si">{</span><span class="n">minimum_lwr</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># print(f&#39;Filtering placements by minimum LWR: {minimum_lwr}&#39;)</span>
        <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

        <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
            <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
                <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
                <span class="k">if</span> <span class="n">lwr</span> <span class="o">&gt;=</span> <span class="n">minimum_lwr</span><span class="p">:</span>
                    <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
                <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
                <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
        <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter_placements_by_max_pendant_to_tree_diameter_ratio</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">max_pendant_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter placements by maximum pendant length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_max_pendant_diameter_ratio_</span><span class="si">{</span><span class="n">max_pendant_ratio</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">tree_diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_tree_diameter</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering placements for tree diameter: </span><span class="si">{</span><span class="n">tree_diameter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

        <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
            <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
                <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
                <span class="k">if</span> <span class="n">pendant_length</span> <span class="o">/</span> <span class="n">tree_diameter</span> <span class="o">&lt;=</span> <span class="n">max_pendant_ratio</span><span class="p">:</span>
                    <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
                <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
                <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
        <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter_placements_by_max_pendant_length</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">max_pendant_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter placements by maximum pendant length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_max_pendant_</span><span class="si">{</span><span class="n">max_pendant_length</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

        <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
            <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
                <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
                <span class="k">if</span> <span class="n">pendant_length</span> <span class="o">&lt;=</span> <span class="n">max_pendant_length</span><span class="p">:</span>
                    <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
                <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
                <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
        <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter_placements_by_max_pendant_to_distal_length_ratio</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">max_pendant_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter placements by maximum pendant length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_max_pendant_distal_ratio_</span><span class="si">{</span><span class="n">max_pendant_ratio</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

        <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
            <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
                <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
                <span class="k">if</span> <span class="n">pendant_length</span> <span class="o">/</span> <span class="n">distal_length</span> <span class="o">&lt;=</span> <span class="n">max_pendant_ratio</span><span class="p">:</span>
                    <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
                <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
                <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
        <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="src.metatag.placement.JplaceParser.fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fields</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Print data fields</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="src.metatag.placement.JplaceParser.meta" class="doc doc-heading">
<code class="highlight language-python"><span class="n">meta</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Print metadata</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="src.metatag.placement.JplaceParser.placements" class="doc doc-heading">
<code class="highlight language-python"><span class="n">placements</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return placement objects</p>
  </div>

</div>



<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.build_branch_dict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">build_branch_dict</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build dictionary with edge/branch numbers as keys and
reference tree leaves as values</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_branch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build dictionary with edge/branch numbers as keys and</span>
<span class="sd">    reference tree leaves as values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;\{(\d+)\}&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">original_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">]</span>
    <span class="n">leaves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>

    <span class="n">branches</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">get_id</span><span class="p">(</span><span class="n">original_tree</span><span class="p">[</span><span class="n">original_tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">:]):</span> <span class="n">leaf</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">branches</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.compute_tree_diameter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_tree_diameter</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Find maximum (pairwise) distance between two tips
(leaves) in the tree</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_tree_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find maximum (pairwise) distance between two tips</span>
<span class="sd">    (leaves) in the tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">root</span>
    <span class="n">max_distance</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">tips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tip</span> <span class="ow">in</span> <span class="n">tips</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
        <span class="n">new_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">depths</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">new_max</span> <span class="o">&gt;</span> <span class="n">max_distance</span><span class="p">:</span>
            <span class="n">max_distance</span> <span class="o">=</span> <span class="n">new_max</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">root_with_outgroup</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">max_distance</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.extract_placement_fields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_placement_fields</span><span class="p">(</span><span class="n">pfielddata</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get dict with placement field values from list of values</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_placement_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pfielddata</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get dict with placement field values from list of values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">pfielddata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.filter_placements_by_max_pendant_length" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_placements_by_max_pendant_length</span><span class="p">(</span><span class="n">max_pendant_length</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Filter placements by maximum pendant length</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_placements_by_max_pendant_length</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">max_pendant_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter placements by maximum pendant length</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_max_pendant_</span><span class="si">{</span><span class="n">max_pendant_length</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

    <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
        <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
            <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
            <span class="k">if</span> <span class="n">pendant_length</span> <span class="o">&lt;=</span> <span class="n">max_pendant_length</span><span class="p">:</span>
                <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
            <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
            <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
    <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.filter_placements_by_max_pendant_to_distal_length_ratio" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_placements_by_max_pendant_to_distal_length_ratio</span><span class="p">(</span><span class="n">max_pendant_ratio</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Filter placements by maximum pendant length</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_placements_by_max_pendant_to_distal_length_ratio</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">max_pendant_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter placements by maximum pendant length</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_max_pendant_distal_ratio_</span><span class="si">{</span><span class="n">max_pendant_ratio</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

    <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
        <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
            <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
            <span class="k">if</span> <span class="n">pendant_length</span> <span class="o">/</span> <span class="n">distal_length</span> <span class="o">&lt;=</span> <span class="n">max_pendant_ratio</span><span class="p">:</span>
                <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
            <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
            <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
    <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.filter_placements_by_max_pendant_to_tree_diameter_ratio" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_placements_by_max_pendant_to_tree_diameter_ratio</span><span class="p">(</span><span class="n">max_pendant_ratio</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Filter placements by maximum pendant length</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_placements_by_max_pendant_to_tree_diameter_ratio</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">max_pendant_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter placements by maximum pendant length</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_max_pendant_diameter_ratio_</span><span class="si">{</span><span class="n">max_pendant_ratio</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">tree_diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_tree_diameter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering placements for tree diameter: </span><span class="si">{</span><span class="n">tree_diameter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

    <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
        <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
            <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
            <span class="k">if</span> <span class="n">pendant_length</span> <span class="o">/</span> <span class="n">tree_diameter</span> <span class="o">&lt;=</span> <span class="n">max_pendant_ratio</span><span class="p">:</span>
                <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
            <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
            <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
    <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.filter_placements_by_minimum_lwr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_placements_by_minimum_lwr</span><span class="p">(</span><span class="n">minimum_lwr</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Filter placements by minimum LWR (from 0 to 1)</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_placements_by_minimum_lwr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">minimum_lwr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter placements by minimum LWR (from 0 to 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_to_jplace</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_min_lwr_</span><span class="si">{</span><span class="n">minimum_lwr</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># print(f&#39;Filtering placements by minimum LWR: {minimum_lwr}&#39;)</span>
    <span class="n">jplace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_json_object</span><span class="p">()</span>

    <span class="n">filtered_placement_objs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">placement_object</span> <span class="ow">in</span> <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]:</span>
        <span class="n">filtered_placements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]:</span>
            <span class="n">edge_num</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">distal_length</span><span class="p">,</span> <span class="n">pendant_length</span> <span class="o">=</span> <span class="n">placement</span>
            <span class="k">if</span> <span class="n">lwr</span> <span class="o">&gt;=</span> <span class="n">minimum_lwr</span><span class="p">:</span>
                <span class="n">filtered_placements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filtered_placements</span><span class="p">:</span>
            <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placements</span>
            <span class="n">filtered_placement_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span>
    <span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_placement_objs</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.get_reference_sequences" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_reference_sequences</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get list of reference sequences in the placement tree</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_reference_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get list of reference sequences in the placement tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tree_obj</span><span class="o">.</span><span class="n">get_terminals</span><span class="p">()]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.get_tree_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_tree_str</span><span class="p">(</span><span class="n">newick</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return tree string in original or newick format
Original format contains branch labels
in curly brackets. Newick format removes
these labels.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_tree_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newick</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return tree string in original or newick format</span>
<span class="sd">    Original format contains branch labels</span>
<span class="sd">    in curly brackets. Newick format removes</span>
<span class="sd">    these labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">newick</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">newickfy_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.newickfy_tree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">newickfy_tree</span><span class="p">(</span><span class="n">tree_str</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Remove branch IDs from jplace tree string</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">newickfy_tree</span><span class="p">(</span><span class="n">tree_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove branch IDs from jplace tree string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subs_tree</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\{(\d+)\}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tree_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subs_tree</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.select_best_placement" class="doc doc-heading">
<code class="highlight language-python"><span class="n">select_best_placement</span><span class="p">(</span><span class="n">placement_object</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Select placement with lowest likelihood</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">select_best_placement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement_object</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select placement with lowest likelihood</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pdata</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_placement_fields</span><span class="p">(</span><span class="n">pfielddata</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pfielddata</span> <span class="ow">in</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">lowest_like_placement</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">lowest_like_placement</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">placement_object</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.JplaceParser.select_best_placements" class="doc doc-heading">
<code class="highlight language-python"><span class="n">select_best_placements</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Select placement with lowest likelihood for
all placement objects in placements</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">select_best_placements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select placement with lowest likelihood for</span>
<span class="sd">    all placement objects in placements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">best_placements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_best_placement</span><span class="p">(</span><span class="n">placement</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">placement</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jplace</span><span class="p">[</span><span class="s2">&quot;placements&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">best_placements</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.placement.TaxAssignParser" class="doc doc-heading">
        <code>TaxAssignParser</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Parse function and taxonomy placement assignments table</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/placement.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TaxAssignParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse function and taxonomy placement assignments table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tax_assign_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tax_assign_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_id</span> <span class="o">!=</span> <span class="s2">&quot;DISTANT&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_score</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_taxopath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_taxopath</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">taxopath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">taxopath</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">taxlevels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Taxopath</span><span class="p">()</span><span class="o">.</span><span class="n">taxlevels</span>

    <span class="k">def</span> <span class="nf">count_hits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cluster_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">taxopath_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;taxopath&quot;</span><span class="p">,</span>
        <span class="n">path_to_query_list</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyCounter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count hits within given cluster ids and at specificied taxon level</span>
<span class="sd">        @Params:</span>
<span class="sd">        normalize=True, then results are reported as fractions of total</span>
<span class="sd">        cluster_ids: IDs of tree clusters to be included in the counting of placements</span>
<span class="sd">        score_threshold: global placement score threshold to filter</span>
<span class="sd">                         low-quality placements out</span>
<span class="sd">        taxopath_type: &#39;taxopath&#39; to use gappa-assign taxopath or &#39;cluster_taxopath&#39;</span>
<span class="sd">                        to use lowest common taxopath of the reference tree cluster</span>
<span class="sd">        path_to_query_list: str, if not None, then a tsv is exported to defined location</span>
<span class="sd">                            containing those queries with correct cluster assignment (</span>
<span class="sd">                                according to defined &#39;valid&#39; cluster ids or threshold</span>
<span class="sd">                            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cluster_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">score_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_threshold</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">query_hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluster_ids</span><span class="p">))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_score</span> <span class="o">&gt;=</span> <span class="n">score_threshold</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">path_to_query_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query_hits</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_query_list</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">taxopath_hits</span> <span class="o">=</span> <span class="n">query_hits</span><span class="p">[</span><span class="n">taxopath_type</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxopath_hits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No placement hits returned for the provided filter parameters&quot;</span>
            <span class="p">)</span>

        <span class="n">taxlevel_counter</span> <span class="o">=</span> <span class="n">TaxonomyCounter</span><span class="p">(</span><span class="n">taxopath_list</span><span class="o">=</span><span class="n">taxopath_hits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">taxlevel_counter</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.placement.TaxAssignParser.count_hits" class="doc doc-heading">
<code class="highlight language-python"><span class="n">count_hits</span><span class="p">(</span><span class="n">cluster_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">score_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">taxopath_type</span><span class="o">=</span><span class="s1">&#39;taxopath&#39;</span><span class="p">,</span> <span class="n">path_to_query_list</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Count hits within given cluster ids and at specificied taxon level
@Params:
normalize=True, then results are reported as fractions of total
cluster_ids: IDs of tree clusters to be included in the counting of placements</p>

<details class="score_threshold">
  <summary>global placement score threshold to filter</summary>
  <p>low-quality placements out</p>
</details>
<details class="taxopath_type">
  <summary>'taxopath' to use gappa-assign taxopath or 'cluster_taxopath'</summary>
  <p>to use lowest common taxopath of the reference tree cluster</p>
</details>
<details class="path_to_query_list">
  <summary>str, if not None, then a tsv is exported to defined location</summary>
  <p>containing those queries with correct cluster assignment (
    according to defined 'valid' cluster ids or threshold
)</p>
</details>
      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">count_hits</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">cluster_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">taxopath_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;taxopath&quot;</span><span class="p">,</span>
    <span class="n">path_to_query_list</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaxonomyCounter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count hits within given cluster ids and at specificied taxon level</span>
<span class="sd">    @Params:</span>
<span class="sd">    normalize=True, then results are reported as fractions of total</span>
<span class="sd">    cluster_ids: IDs of tree clusters to be included in the counting of placements</span>
<span class="sd">    score_threshold: global placement score threshold to filter</span>
<span class="sd">                     low-quality placements out</span>
<span class="sd">    taxopath_type: &#39;taxopath&#39; to use gappa-assign taxopath or &#39;cluster_taxopath&#39;</span>
<span class="sd">                    to use lowest common taxopath of the reference tree cluster</span>
<span class="sd">    path_to_query_list: str, if not None, then a tsv is exported to defined location</span>
<span class="sd">                        containing those queries with correct cluster assignment (</span>
<span class="sd">                            according to defined &#39;valid&#39; cluster ids or threshold</span>
<span class="sd">                        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cluster_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cluster_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">score_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">score_threshold</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">query_hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="p">[</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cluster_ids</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_assign</span><span class="o">.</span><span class="n">cluster_score</span> <span class="o">&gt;=</span> <span class="n">score_threshold</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">path_to_query_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query_hits</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_query_list</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">taxopath_hits</span> <span class="o">=</span> <span class="n">query_hits</span><span class="p">[</span><span class="n">taxopath_type</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxopath_hits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No placement hits returned for the provided filter parameters&quot;</span>
        <span class="p">)</span>

    <span class="n">taxlevel_counter</span> <span class="o">=</span> <span class="n">TaxonomyCounter</span><span class="p">(</span><span class="n">taxopath_list</span><span class="o">=</span><span class="n">taxopath_hits</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">taxlevel_counter</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.add_clusters_to_tax_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_clusters_to_tax_table</span><span class="p">(</span><span class="n">in_taxtable</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">out_taxtable</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Add tree cluster info at the beginning of each taxopath
according to clusters defined in dictionary 'clusters'</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_clusters_to_tax_table</span><span class="p">(</span>
    <span class="n">in_taxtable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">out_taxtable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add tree cluster info at the beginning of each taxopath</span>
<span class="sd">    according to clusters defined in dictionary &#39;clusters&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out_taxtable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_taxtable</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">in_taxtable</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_clustered&quot;</span><span class="p">)</span>
    <span class="n">taxtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_taxtable</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">taxtable</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">taxtable</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_taxtable</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.add_duplicates_to_assignment_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_duplicates_to_assignment_table</span><span class="p">(</span><span class="n">taxtable</span><span class="p">,</span> <span class="n">query_duplicates</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Add duplicated query IDs to cluster and taxonomic assignment table</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_duplicates_to_assignment_table</span><span class="p">(</span>
    <span class="n">taxtable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query_duplicates</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add duplicated query IDs to cluster and taxonomic assignment table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">taxtable</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_duplicates&quot;</span><span class="p">)</span>

    <span class="n">assigns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">taxtable</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">dup_dict</span> <span class="o">=</span> <span class="n">parse_duplicates_from_seqkit</span><span class="p">(</span><span class="n">query_duplicates</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">duplicate_string</span> <span class="ow">in</span> <span class="n">dup_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="n">duplicate_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">duplicate</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">assigns</span><span class="p">[</span><span class="n">assigns</span><span class="o">.</span><span class="n">query_name</span> <span class="o">==</span> <span class="n">query_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">row</span><span class="o">.</span><span class="n">query_name</span> <span class="o">=</span> <span class="n">duplicate</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">assigns</span> <span class="o">=</span> <span class="n">assigns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">assigns</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.add_query_labels_to_assign_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_query_labels_to_assign_table</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">query_labels</span><span class="p">,</span> <span class="n">output_table</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Add new column containing actual query labels to query taxonomy/cluster assignment
table</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_query_labels_to_assign_table</span><span class="p">(</span>
    <span class="n">input_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query_labels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add new column containing actual query labels to query taxonomy/cluster assignment</span>
<span class="sd">    table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">relabel_query</span><span class="p">(</span><span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query_labels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_labels</span><span class="p">[</span><span class="n">query_id</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_id</span>

    <span class="k">if</span> <span class="n">output_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_table</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_relabel&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;query_name&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">query_id</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">relabel_query</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">query_labels</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;query_id&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.assign_labels_to_placements" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_labels_to_placements</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">ref_labels</span><span class="p">,</span> <span class="n">query_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">only_best_hit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ref_clusters_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_cluster_scores_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gappa_additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">only_unique_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">taxo_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Assign taxonomy and/or tree cluster IDs to placed query sequences based on
taxonomy assigned to tree reference sequences using
gappa examine assign.
@parameter</p>

<details class="ref_labels">
  <summary>dictionary containing short IDs as keys and long labels as values</summary>
  <p>for reference sequences</p>
</details>
<details class="query_labels">
  <summary>dictionary containing short IDs as keys and long labels as values</summary>
  <p>for query sequences</p>
</details>
<details class="only_best_hit">
  <summary>only report taxonomy with largest LWR</summary>
  <p>per query</p>
</details>
<details class="ref_clusters">
  <summary>dict (optionally) add tree cluster to the</summary>
  <p>beginning of the taxopath so query sequences
can also be classified according to tree
cluster (e.g., assigned function)</p>
</details>
<details class="only_unique_cluster">
  <summary>if True, keep only queries with multiple placement locations</summary>
  <p>if they were assigned to the same cluster.</p>
</details>
      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_labels_to_placements</span><span class="p">(</span>
    <span class="n">jplace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ref_labels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">query_labels</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">only_best_hit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ref_clusters_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ref_cluster_scores_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">gappa_additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">only_unique_cluster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">taxo_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign taxonomy and/or tree cluster IDs to placed query sequences based on</span>
<span class="sd">    taxonomy assigned to tree reference sequences using</span>
<span class="sd">    gappa examine assign.</span>
<span class="sd">    @parameter</span>
<span class="sd">    ref_labels: dictionary containing short IDs as keys and long labels as values</span>
<span class="sd">                for reference sequences</span>
<span class="sd">    query_labels: dictionary containing short IDs as keys and long labels as values</span>
<span class="sd">                  for query sequences</span>
<span class="sd">    only_best_hit: only report taxonomy with largest LWR</span>
<span class="sd">                   per query</span>
<span class="sd">    ref_clusters: dict (optionally) add tree cluster to the</span>
<span class="sd">                  beginning of the taxopath so query sequences</span>
<span class="sd">                  can also be classified according to tree</span>
<span class="sd">                  cluster (e.g., assigned function)</span>
<span class="sd">    only_unique_cluster: if True, keep only queries with multiple placement locations</span>
<span class="sd">                         if they were assigned to the same cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ref_clusters_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">has_cluster_id</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ref_clusters</span> <span class="o">=</span> <span class="n">parse_tree_clusters</span><span class="p">(</span>
            <span class="n">ref_clusters_file</span><span class="p">,</span> <span class="n">cluster_as_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">ref_clusters_as_keys</span> <span class="o">=</span> <span class="n">parse_tree_clusters</span><span class="p">(</span>
            <span class="n">ref_clusters_file</span><span class="p">,</span> <span class="n">cluster_as_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">has_cluster_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">ref_cluster_scores_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref_cluster_scores</span> <span class="o">=</span> <span class="n">parse_tree_cluster_quality_scores</span><span class="p">(</span><span class="n">ref_cluster_scores_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_cluster_scores</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">taxo_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">taxo_file</span> <span class="o">=</span> <span class="n">package_dir</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;merged_taxonomy.tsv&quot;</span>

    <span class="n">gappa_assign_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;per_query.tsv&quot;</span><span class="p">)</span>
    <span class="n">query_taxo_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;assignments.tsv&quot;</span><span class="p">)</span>

    <span class="c1"># Remove references that are not in placement tree</span>
    <span class="n">ref_in_jplace_tree</span> <span class="o">=</span> <span class="n">JplaceParser</span><span class="p">(</span><span class="n">jplace</span><span class="p">)</span><span class="o">.</span><span class="n">get_reference_sequences</span><span class="p">()</span>
    <span class="n">ref_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ref_labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ref_in_jplace_tree</span><span class="p">}</span>

    <span class="k">with</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">temptax</span><span class="p">:</span>
        <span class="n">taxonomy</span> <span class="o">=</span> <span class="n">TaxonomyAssigner</span><span class="p">(</span><span class="n">taxo_file</span><span class="o">=</span><span class="n">taxo_file</span><span class="p">)</span>
        <span class="n">taxonomy</span><span class="o">.</span><span class="n">build_gappa_taxonomy_table</span><span class="p">(</span><span class="n">ref_labels</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">temptax</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_cluster_id</span><span class="p">:</span>
            <span class="n">add_clusters_to_tax_table</span><span class="p">(</span>
                <span class="n">in_taxtable</span><span class="o">=</span><span class="n">temptax</span><span class="p">,</span> <span class="n">clusters</span><span class="o">=</span><span class="n">ref_clusters</span><span class="p">,</span> <span class="n">out_taxtable</span><span class="o">=</span><span class="n">temptax</span>
            <span class="p">)</span>
            <span class="n">clusters_taxopath</span> <span class="o">=</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">assign_lowest_common_taxonomy_to_clusters</span><span class="p">(</span>
                <span class="n">clusters</span><span class="o">=</span><span class="n">ref_clusters_as_keys</span><span class="p">,</span> <span class="n">label_dict</span><span class="o">=</span><span class="n">ref_labels</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clusters_taxopath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">wrappers</span><span class="o">.</span><span class="n">run_gappa_assign</span><span class="p">(</span>
            <span class="n">jplace</span><span class="o">=</span><span class="n">jplace</span><span class="p">,</span>
            <span class="n">taxonomy_file</span><span class="o">=</span><span class="n">temptax</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">output_prefix</span><span class="o">=</span><span class="n">output_prefix</span><span class="p">,</span>
            <span class="n">only_best_hit</span><span class="o">=</span><span class="n">only_best_hit</span><span class="p">,</span>
            <span class="n">additional_args</span><span class="o">=</span><span class="n">gappa_additional_args</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempout</span><span class="p">,</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempout2</span><span class="p">,</span> <span class="n">TemporaryFilePath</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempout3</span><span class="p">:</span>
        <span class="n">parse_gappa_assign_table</span><span class="p">(</span>
            <span class="n">input_table</span><span class="o">=</span><span class="n">gappa_assign_out</span><span class="p">,</span>
            <span class="n">has_cluster_id</span><span class="o">=</span><span class="n">has_cluster_id</span><span class="p">,</span>
            <span class="n">cluster_scores</span><span class="o">=</span><span class="n">ref_cluster_scores</span><span class="p">,</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">tempout</span><span class="p">,</span>
            <span class="n">clusters_taxopath</span><span class="o">=</span><span class="n">clusters_taxopath</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">only_unique_cluster</span><span class="p">:</span>
            <span class="n">filter_non_unique_placement_assignments</span><span class="p">(</span>
                <span class="n">placed_tax_assignments</span><span class="o">=</span><span class="n">tempout</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">tempout2</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tempout2</span><span class="p">,</span> <span class="n">tempout</span><span class="p">)</span>

        <span class="n">pick_taxopath_with_highest_lwr</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="o">=</span><span class="n">tempout</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">tempout3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">add_query_labels_to_assign_table</span><span class="p">(</span>
                <span class="n">input_table</span><span class="o">=</span><span class="n">tempout3</span><span class="p">,</span>
                <span class="n">query_labels</span><span class="o">=</span><span class="n">query_labels</span><span class="p">,</span>
                <span class="n">output_table</span><span class="o">=</span><span class="n">query_taxo_out</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tempout3</span><span class="p">,</span> <span class="n">query_taxo_out</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.filter_non_unique_placement_assignments" class="doc doc-heading">
<code class="highlight language-python"><span class="n">filter_non_unique_placement_assignments</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Remove queries that were assigned to more than one cluster from placements assignments table</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter_non_unique_placement_assignments</span><span class="p">(</span>
    <span class="n">placed_tax_assignments</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove queries that were assigned to more than one cluster from placements assignments table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_filtered&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">queries_in_more_than_one_cluster</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_queries_placed_in_several_clusters</span><span class="p">(</span>
        <span class="n">placed_tax_assignments</span>
    <span class="p">)</span>
    <span class="n">fdf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">query_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">queries_in_more_than_one_cluster</span><span class="p">)]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;query_id&quot;</span><span class="p">)</span>
    <span class="n">fdf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.find_queries_placed_in_several_clusters" class="doc doc-heading">
<code class="highlight language-python"><span class="n">find_queries_placed_in_several_clusters</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Find queries placed in more than one clusterrunGappaAssign</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">find_queries_placed_in_several_clusters</span><span class="p">(</span>
    <span class="n">placed_tax_assignments</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find queries placed in more than one clusterrunGappaAssign</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">dfu</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;query_id&quot;</span><span class="p">)[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;unique&quot;</span><span class="p">])</span>

    <span class="n">queries_in_more_than_one_cluster</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dfu</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">queries_in_more_than_one_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">queries_in_more_than_one_cluster</span><span class="p">,</span> <span class="n">dfu</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.parse_duplicates_from_seqkit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_duplicates_from_seqkit</span><span class="p">(</span><span class="n">query_duplicates</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Add a column with the query IDs of duplicated sequences to the taxonomy assignments file.
@params:
taxtable: tsv with query taxonomic and cluster assignments as output by labelplacements.py
query_duplicates: text file containing query duplicate IDs as output by seqkit rmdup</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_duplicates_from_seqkit</span><span class="p">(</span><span class="n">query_duplicates</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a column with the query IDs of duplicated sequences to the taxonomy assignments file.</span>
<span class="sd">    @params:</span>
<span class="sd">    taxtable: tsv with query taxonomic and cluster assignments as output by labelplacements.py</span>
<span class="sd">    query_duplicates: text file containing query duplicate IDs as output by seqkit rmdup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">query_duplicates</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">dup_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">dup_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">seq_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq_name</span> <span class="ow">in</span> <span class="n">dup_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dup_pair</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dup_labels</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.parse_gappa_assign_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_gappa_assign_table</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">has_cluster_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cluster_scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clusters_taxopath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parse gappa assign per query taxonomy assignment result tsv</p>

<details class="has_cluster_id">
  <summary>set to True if results table includes reference</summary>
  <p>cluster info in the first element of taxopath</p>
</details>
<details class="cluster_scores">
  <summary>dictionary with values set to cluster quality</summary>
  <p>scores. It is only used if has_cluster_id = True.</p>
</details>
      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_gappa_assign_table</span><span class="p">(</span>
    <span class="n">input_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">has_cluster_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cluster_scores</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clusters_taxopath</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse gappa assign per query taxonomy assignment result tsv</span>
<span class="sd">    has_cluster_id: set to True if results table includes reference</span>
<span class="sd">                    cluster info in the first element of taxopath</span>
<span class="sd">    cluster_scores: dictionary with values set to cluster quality</span>
<span class="sd">                    scores. It is only used if has_cluster_id = True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_parsed&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">has_cluster_id</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cluster_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">cluster_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;cluster_id&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cluster_score&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cluster_taxopath&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">has_cluster_id</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cluster_scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">cluster_str</span> <span class="o">=</span> <span class="s2">&quot;cluster_id&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cluster_taxopath&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">has_cluster_id</span><span class="p">:</span>
        <span class="n">cluster_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;query_id&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;LWR&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">cluster_str</span> <span class="o">+</span> <span class="s2">&quot;taxopath&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">taxopath</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">taxopath</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">taxopath</span> <span class="o">+</span> <span class="s2">&quot;;Unspecified&quot;</span>
            <span class="k">if</span> <span class="n">has_cluster_id</span><span class="p">:</span>
                <span class="n">elems</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">taxopath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="n">cluster_id</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="n">clusters_taxopath</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">cluster_taxopath</span> <span class="o">=</span> <span class="n">clusters_taxopath</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster_taxopath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_taxopath</span><span class="p">:</span>
                    <span class="n">cluster_taxopath</span> <span class="o">=</span> <span class="s2">&quot;Unspecified&quot;</span>
                <span class="n">taxopath</span> <span class="o">=</span> <span class="n">cluster_taxopath</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster_id</span><span class="p">,</span> <span class="n">taxopath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">taxopath</span>
            <span class="k">if</span> <span class="n">cluster_scores</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="n">cluster_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">cluster_score</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_scores</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster_score</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;LWR&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">cluster_id</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">cluster_score</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">taxopath</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;LWR&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">cluster_id</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">taxopath</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.parse_tree_cluster_quality_scores" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_tree_cluster_quality_scores</span><span class="p">(</span><span class="n">cluster_scores_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parse cluster quality scores file into dictionary</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_tree_cluster_quality_scores</span><span class="p">(</span><span class="n">cluster_scores_tsv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse cluster quality scores file into dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">cluster_scores_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.parse_tree_clusters" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_tree_clusters</span><span class="p">(</span><span class="n">clusters_tsv</span><span class="p">,</span> <span class="n">cluster_as_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parse clusters text file into dictionary
@param
clusters_as_key: if True then dict keys are cluster IDs and values
are lists of reference IDs. If False, dict keys are reference IDs and
values the cluster to which they belong.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_tree_clusters</span><span class="p">(</span>
    <span class="n">clusters_tsv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cluster_as_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse clusters text file into dictionary</span>
<span class="sd">    @param</span>
<span class="sd">    clusters_as_key: if True then dict keys are cluster IDs and values</span>
<span class="sd">    are lists of reference IDs. If False, dict keys are reference IDs and</span>
<span class="sd">    values the cluster to which they belong.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">clusters_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cluster_as_key</span><span class="p">:</span>
        <span class="n">cluster_ids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">cluster_id</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">cluster</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="n">cluster_ids</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.pick_taxopath_with_highest_lwr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">pick_taxopath_with_highest_lwr</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Pick taxopath assigment with higuest LWR for each placed query</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pick_taxopath_with_highest_lwr</span><span class="p">(</span>
    <span class="n">placed_tax_assignments</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pick taxopath assigment with higuest LWR for each placed query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_unique_taxopath&quot;</span>
        <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">placed_tax_assignments</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;query_id&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;LWR&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.placement.place_reads_onto_tree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">place_reads_onto_tree</span><span class="p">(</span><span class="n">input_tree</span><span class="p">,</span> <span class="n">tree_model</span><span class="p">,</span> <span class="n">ref_aln</span><span class="p">,</span> <span class="n">query_seqs</span><span class="p">,</span> <span class="n">aln_method</span><span class="o">=</span><span class="s1">&#39;papara&#39;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Performs short read placement onto phylogenetic tree
tree_model: str, either the model name or path to log output by iqtree
workflow example: https://github.com/Pbdas/epa-ng/wiki/Full-Stack-Example</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/placement.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">place_reads_onto_tree</span><span class="p">(</span>
    <span class="n">input_tree</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tree_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ref_aln</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">query_seqs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">aln_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;papara&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs short read placement onto phylogenetic tree</span>
<span class="sd">    tree_model: str, either the model name or path to log output by iqtree</span>
<span class="sd">    workflow example: https://github.com/Pbdas/epa-ng/wiki/Full-Stack-Example</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">query_seqs</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tree_model</span><span class="p">):</span>
        <span class="n">tree_model</span> <span class="o">=</span> <span class="n">get_iq_tree_model_from_log_file</span><span class="p">(</span><span class="n">tree_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running EPA-ng with inferred substitution model: </span><span class="si">{</span><span class="n">tree_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ref_ids</span> <span class="o">=</span> <span class="n">get_fasta_record_ids</span><span class="p">(</span><span class="n">ref_aln</span><span class="p">)</span>
    <span class="n">ref_query_msa</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">output_dir</span><span class="p">,</span>
        <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">query_seqs</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.faln&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">aln_ref_frac</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_ref_fraction.faln&quot;</span>
    <span class="n">aln_query_frac</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ref_query_msa</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_query_fraction.faln&quot;</span>

    <span class="n">align_short_reads_to_reference_msa</span><span class="p">(</span>
        <span class="n">ref_msa</span><span class="o">=</span><span class="n">ref_aln</span><span class="p">,</span>
        <span class="n">query_seqs</span><span class="o">=</span><span class="n">query_seqs</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">aln_method</span><span class="p">,</span>
        <span class="n">tree_nwk</span><span class="o">=</span><span class="n">input_tree</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">split_reference_from_query_alignments</span><span class="p">(</span>
        <span class="n">ref_query_msa</span><span class="o">=</span><span class="n">ref_query_msa</span><span class="p">,</span> <span class="n">ref_ids</span><span class="o">=</span><span class="n">ref_ids</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">output_dir</span>
    <span class="p">)</span>

    <span class="n">wrappers</span><span class="o">.</span><span class="n">run_epang</span><span class="p">(</span>
        <span class="n">input_tree</span><span class="o">=</span><span class="n">input_tree</span><span class="p">,</span>
        <span class="n">input_aln_ref</span><span class="o">=</span><span class="n">aln_ref_frac</span><span class="p">,</span>
        <span class="n">input_aln_query</span><span class="o">=</span><span class="n">aln_query_frac</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="n">n_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-taxonomy">Module taxonomy</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.taxonomy"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to assign taxonomy to reference and query (placed) sequences</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.taxonomy.TaxonomyAssigner" class="doc doc-heading">
        <code>TaxonomyAssigner</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Methods to assign taxonomy to reference sequences</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TaxonomyAssigner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods to assign taxonomy to reference sequences</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxo_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taxodata</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">taxo_file</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">lowest_common_taxonomy</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find lowest common taxonomy among set of taxopaths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">taxopaths</span><span class="p">])</span>
        <span class="n">taxlevels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;d__&quot;</span><span class="p">,</span> <span class="s2">&quot;p__&quot;</span><span class="p">,</span> <span class="s2">&quot;c__&quot;</span><span class="p">,</span> <span class="s2">&quot;o__&quot;</span><span class="p">,</span> <span class="s2">&quot;f__&quot;</span><span class="p">,</span> <span class="s2">&quot;g__&quot;</span><span class="p">,</span> <span class="s2">&quot;s__&quot;</span><span class="p">]</span>
        <span class="n">lowest_tax</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tax_level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taxlevels</span><span class="p">):</span>
            <span class="n">taxa</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lowest_tax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taxa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lowest_tax</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_genome_id_from_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">genome_id</span> <span class="o">=</span> <span class="n">LabelParser</span><span class="o">.</span><span class="n">extract_genome_id</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">genome_id</span>

    <span class="k">def</span> <span class="nf">assign_taxonomy_to_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign GTDB taxonomy to label based on genome ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">genome_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_genome_id_from_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">genome_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxodata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxodata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genome_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No_taxonomy_found&quot;</span>

    <span class="k">def</span> <span class="nf">assign_lowest_common_taxonomy_to_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assing taxonomy to set of labels and find lowest common taxonomy</span>
<span class="sd">        among them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">taxopaths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">taxopath</span>
            <span class="k">for</span> <span class="n">taxopath</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_taxonomy_to_label</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">taxopath</span> <span class="o">!=</span> <span class="s2">&quot;No_taxonomy_found&quot;</span>
        <span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">taxopaths</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowest_common_taxonomy</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Unspecified&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Unspecified&quot;</span>

    <span class="k">def</span> <span class="nf">assign_lowest_common_taxonomy_to_clusters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find lowest possible common taxonomy to reference labels in clusters</span>
<span class="sd">        If reference labels do not contain genome IDs, a dictionary, label_dict,</span>
<span class="sd">        of reference labels and genome ids (or labels with genome ids) must be passed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clusters_taxopath</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cluster_id</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">label_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cluster_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_dict</span><span class="p">[</span><span class="n">ref_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">ref_id</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">cluster</span>
            <span class="n">taxopath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_lowest_common_taxonomy_to_labels</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">)</span>
            <span class="n">clusters_taxopath</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxopath</span>
        <span class="k">return</span> <span class="n">clusters_taxopath</span>

    <span class="k">def</span> <span class="nf">build_gappa_taxonomy_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ref_id_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build gappa-compatible taxonomy file as specified here:</span>
<span class="sd">        https://github.com/lczech/gappa/wiki/Subcommand:-assign</span>
<span class="sd">        Removes references without assigned taxonomy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;gappa_taxonomy.tsv&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ref_id</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ref_id_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">taxon_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_taxonomy_to_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">taxon_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;No_taxonomy_found&quot;</span> <span class="ow">in</span> <span class="n">taxon_str</span><span class="p">)</span> <span class="k">else</span> <span class="n">taxon_str</span>
                <span class="p">)</span>
                <span class="c1"># if taxon_str != &#39;Unspecified&#39;:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_id</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">taxon_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyAssigner.assign_lowest_common_taxonomy_to_clusters" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_lowest_common_taxonomy_to_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">label_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Find lowest possible common taxonomy to reference labels in clusters
If reference labels do not contain genome IDs, a dictionary, label_dict,
of reference labels and genome ids (or labels with genome ids) must be passed</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_lowest_common_taxonomy_to_clusters</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find lowest possible common taxonomy to reference labels in clusters</span>
<span class="sd">    If reference labels do not contain genome IDs, a dictionary, label_dict,</span>
<span class="sd">    of reference labels and genome ids (or labels with genome ids) must be passed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clusters_taxopath</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cluster_id</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">label_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cluster_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_dict</span><span class="p">[</span><span class="n">ref_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">ref_id</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">cluster</span>
        <span class="n">taxopath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_lowest_common_taxonomy_to_labels</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">)</span>
        <span class="n">clusters_taxopath</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxopath</span>
    <span class="k">return</span> <span class="n">clusters_taxopath</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyAssigner.assign_lowest_common_taxonomy_to_labels" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_lowest_common_taxonomy_to_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Assing taxonomy to set of labels and find lowest common taxonomy
among them</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_lowest_common_taxonomy_to_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assing taxonomy to set of labels and find lowest common taxonomy</span>
<span class="sd">    among them</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taxopaths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">taxopath</span>
        <span class="k">for</span> <span class="n">taxopath</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_taxonomy_to_label</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">taxopath</span> <span class="o">!=</span> <span class="s2">&quot;No_taxonomy_found&quot;</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">taxopaths</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowest_common_taxonomy</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Unspecified&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Unspecified&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyAssigner.assign_taxonomy_to_label" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_taxonomy_to_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Assign GTDB taxonomy to label based on genome ID</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_taxonomy_to_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign GTDB taxonomy to label based on genome ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">genome_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_genome_id_from_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">genome_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxodata</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxodata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genome_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;No_taxonomy_found&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyAssigner.build_gappa_taxonomy_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">build_gappa_taxonomy_table</span><span class="p">(</span><span class="n">ref_id_dict</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build gappa-compatible taxonomy file as specified here:
https://github.com/lczech/gappa/wiki/Subcommand:-assign
Removes references without assigned taxonomy</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_gappa_taxonomy_table</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">ref_id_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build gappa-compatible taxonomy file as specified here:</span>
<span class="sd">    https://github.com/lczech/gappa/wiki/Subcommand:-assign</span>
<span class="sd">    Removes references without assigned taxonomy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;gappa_taxonomy.tsv&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ref_id</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ref_id_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">taxon_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_taxonomy_to_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">taxon_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;No_taxonomy_found&quot;</span> <span class="ow">in</span> <span class="n">taxon_str</span><span class="p">)</span> <span class="k">else</span> <span class="n">taxon_str</span>
            <span class="p">)</span>
            <span class="c1"># if taxon_str != &#39;Unspecified&#39;:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_id</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">taxon_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyAssigner.lowest_common_taxonomy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lowest_common_taxonomy</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Find lowest common taxonomy among set of taxopaths</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">lowest_common_taxonomy</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find lowest common taxonomy among set of taxopaths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">taxopaths</span><span class="p">])</span>
    <span class="n">taxlevels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;d__&quot;</span><span class="p">,</span> <span class="s2">&quot;p__&quot;</span><span class="p">,</span> <span class="s2">&quot;c__&quot;</span><span class="p">,</span> <span class="s2">&quot;o__&quot;</span><span class="p">,</span> <span class="s2">&quot;f__&quot;</span><span class="p">,</span> <span class="s2">&quot;g__&quot;</span><span class="p">,</span> <span class="s2">&quot;s__&quot;</span><span class="p">]</span>
    <span class="n">lowest_tax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tax_level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">taxlevels</span><span class="p">):</span>
        <span class="n">taxa</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lowest_tax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taxa</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lowest_tax</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.taxonomy.TaxonomyCounter" class="doc doc-heading">
        <code>TaxonomyCounter</code>


</h2>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TaxonomyCounter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxopath_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tools to summarize taxonomical diversity in a list of taxopaths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">taxodicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Taxopath</span><span class="p">(</span><span class="n">taxopath_str</span><span class="p">)</span><span class="o">.</span><span class="n">taxodict</span> <span class="k">for</span> <span class="n">taxopath_str</span> <span class="ow">in</span> <span class="n">taxopath_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taxohits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">taxodicts</span><span class="p">)</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_counts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">taxlevel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;family&quot;</span><span class="p">,</span>
        <span class="n">output_tsv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
        <span class="n">output_pdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute counts and fraction at specified taxonomy levels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxohits</span><span class="p">[</span><span class="n">taxlevel</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Merge counts from &quot;Unspecified&quot; and empty tax level, e.g., &quot;f__&quot;</span>
        <span class="n">matched_row</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="s2">&quot;[a-zA-Z]__&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">empty_tax_level</span> <span class="o">=</span> <span class="n">matched_row</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">counts</span><span class="p">[</span><span class="n">empty_tax_level</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">empty_tax_level</span><span class="p">)</span>

        <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">taxlevel</span>
        <span class="c1"># Add fraction</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;counts&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">output_tsv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Make figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_counts</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
            <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Taxonomy at level: </span><span class="si">{</span><span class="n">taxlevel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">plot_counts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">count_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
        <span class="n">output_pdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make (and optionally export) barplot (&#39;bar&#39;) or pieplot (&#39;pie&#39;)</span>
<span class="sd">        figure depicting counting results at specified taxonomic level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;pie&quot;</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">count_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rotatelabels</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">count_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">90</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_pdf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyCounter.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">taxopath_list</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Tools to summarize taxonomical diversity in a list of taxopaths</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxopath_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tools to summarize taxonomical diversity in a list of taxopaths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taxodicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Taxopath</span><span class="p">(</span><span class="n">taxopath_str</span><span class="p">)</span><span class="o">.</span><span class="n">taxodict</span> <span class="k">for</span> <span class="n">taxopath_str</span> <span class="ow">in</span> <span class="n">taxopath_list</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_taxohits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">taxodicts</span><span class="p">)</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyCounter.get_counts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_counts</span><span class="p">(</span><span class="n">taxlevel</span><span class="o">=</span><span class="s1">&#39;family&#39;</span><span class="p">,</span> <span class="n">output_tsv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">output_pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Compute counts and fraction at specified taxonomy levels</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_counts</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">taxlevel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;family&quot;</span><span class="p">,</span>
    <span class="n">output_tsv</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="n">output_pdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute counts and fraction at specified taxonomy levels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxohits</span><span class="p">[</span><span class="n">taxlevel</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Merge counts from &quot;Unspecified&quot; and empty tax level, e.g., &quot;f__&quot;</span>
    <span class="n">matched_row</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="s2">&quot;[a-zA-Z]__&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">empty_tax_level</span> <span class="o">=</span> <span class="n">matched_row</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">counts</span><span class="p">[</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">counts</span><span class="p">[</span><span class="n">empty_tax_level</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">empty_tax_level</span><span class="p">)</span>

    <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">taxlevel</span>
    <span class="c1"># Add fraction</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;counts&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">output_tsv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Make figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_counts</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
        <span class="n">output_pdf</span><span class="o">=</span><span class="n">output_pdf</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Taxonomy at level: </span><span class="si">{</span><span class="n">taxlevel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.TaxonomyCounter.plot_counts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">plot_counts</span><span class="p">(</span><span class="n">count_data</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">output_pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Make (and optionally export) barplot ('bar') or pieplot ('pie')
figure depicting counting results at specified taxonomic level</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">plot_counts</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">count_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">plot_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="n">output_pdf</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make (and optionally export) barplot (&#39;bar&#39;) or pieplot (&#39;pie&#39;)</span>
<span class="sd">    figure depicting counting results at specified taxonomic level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;pie&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">count_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rotatelabels</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">count_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">90</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_pdf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.taxonomy.Taxopath" class="doc doc-heading">
        <code>Taxopath</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Object to contain taxopath</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Taxopath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object to contain taxopath</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxopath_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taxopath</span> <span class="o">=</span> <span class="n">taxopath_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delimiter</span> <span class="o">=</span> <span class="n">delimiter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tax_levels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;domain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phylum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;order&quot;</span><span class="p">,</span>
            <span class="s2">&quot;family&quot;</span><span class="p">,</span>
            <span class="s2">&quot;genus&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taxodict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_from_taxopath</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_dict_from_taxopath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxopath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">taxolist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">taxolist</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxopath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delimiter</span><span class="p">)]</span>
        <span class="n">taxolist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_levels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxolist</span><span class="p">))])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">taxlevel</span><span class="p">:</span> <span class="n">taxon</span> <span class="k">for</span> <span class="n">taxlevel</span><span class="p">,</span> <span class="n">taxon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tax_levels</span><span class="p">,</span> <span class="n">taxolist</span><span class="p">)}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">taxodict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Taxopath</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiate Taxopath object from dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">taxa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">taxon</span> <span class="ow">in</span> <span class="n">taxodict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">taxon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">taxa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taxon</span><span class="p">)</span>
        <span class="n">taxostr</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">taxopath_str</span><span class="o">=</span><span class="n">taxostr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_lowest_common_taxopath</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">taxopaths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Taxopath</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute lowest common taxopath (ancestor) of a list</span>
<span class="sd">        of taxopaths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">taxopath_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="n">taxostr</span><span class="p">)</span><span class="o">.</span><span class="n">taxodict</span> <span class="k">for</span> <span class="n">taxostr</span> <span class="ow">in</span> <span class="n">taxopaths</span><span class="p">]</span>
        <span class="n">common_taxodict</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">taxodict</span>
        <span class="k">for</span> <span class="n">taxlevel</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">taxlevels</span><span class="p">:</span>
            <span class="n">taxa</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">taxdict</span><span class="p">[</span><span class="n">taxlevel</span><span class="p">]</span> <span class="k">for</span> <span class="n">taxdict</span> <span class="ow">in</span> <span class="n">taxopath_dicts</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">common_taxodict</span><span class="p">[</span><span class="n">taxlevel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">taxa</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">common_taxodict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">taxostring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taxopath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">taxlevels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tax_levels</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.Taxopath.from_dict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">from_dict</span><span class="p">(</span><span class="n">taxodict</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Instantiate Taxopath object from dict</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">taxodict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Taxopath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instantiate Taxopath object from dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taxa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">taxon</span> <span class="ow">in</span> <span class="n">taxodict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">taxon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">taxa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taxon</span><span class="p">)</span>
    <span class="n">taxostr</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">taxopath_str</span><span class="o">=</span><span class="n">taxostr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.taxonomy.Taxopath.get_lowest_common_taxopath" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_lowest_common_taxopath</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>compute lowest common taxopath (ancestor) of a list
of taxopaths</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_lowest_common_taxopath</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">taxopaths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Taxopath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute lowest common taxopath (ancestor) of a list</span>
<span class="sd">    of taxopaths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taxopath_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="n">taxostr</span><span class="p">)</span><span class="o">.</span><span class="n">taxodict</span> <span class="k">for</span> <span class="n">taxostr</span> <span class="ow">in</span> <span class="n">taxopaths</span><span class="p">]</span>
    <span class="n">common_taxodict</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">taxodict</span>
    <span class="k">for</span> <span class="n">taxlevel</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">taxlevels</span><span class="p">:</span>
        <span class="n">taxa</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">taxdict</span><span class="p">[</span><span class="n">taxlevel</span><span class="p">]</span> <span class="k">for</span> <span class="n">taxdict</span> <span class="ow">in</span> <span class="n">taxopath_dicts</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">common_taxodict</span><span class="p">[</span><span class="n">taxlevel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">taxa</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">common_taxodict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.metatag.taxonomy.evaluate_taxonomy_of_reference_database" class="doc doc-heading">
<code class="highlight language-python"><span class="n">evaluate_taxonomy_of_reference_database</span><span class="p">(</span><span class="n">label_dict_pickle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">taxlevels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_results</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Assign taxonomy to sequences and evaluate taxonomical representation</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/taxonomy.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_taxonomy_of_reference_database</span><span class="p">(</span>
    <span class="n">label_dict_pickle</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">taxlevels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign taxonomy to sequences and evaluate taxonomical representation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">taxlevels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">taxlevels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;family&quot;</span><span class="p">,</span> <span class="s2">&quot;genus&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">label_dict_pickle</span><span class="p">,</span> <span class="n">only_dir_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">taxonomy</span> <span class="o">=</span> <span class="n">TaxonomyAssigner</span><span class="p">(</span><span class="n">taxo_file</span><span class="o">=</span><span class="s2">&quot;./data/merged_taxonomy.tsv&quot;</span><span class="p">)</span>
    <span class="n">label_dict</span> <span class="o">=</span> <span class="n">read_from_pickle_file</span><span class="p">(</span><span class="n">label_dict_pickle</span><span class="p">)</span>
    <span class="n">taxopaths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">taxonomy</span><span class="o">.</span><span class="n">assign_taxonomy_to_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">taxcounter</span> <span class="o">=</span> <span class="n">TaxonomyCounter</span><span class="p">(</span><span class="n">taxopaths</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">taxlevel</span> <span class="ow">in</span> <span class="n">taxlevels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plot_results</span><span class="p">:</span>
            <span class="n">outpdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ref_taxonomy_counts_</span><span class="si">{</span><span class="n">taxlevel</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outpdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">taxcounter</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span>
            <span class="n">taxlevel</span><span class="p">,</span>
            <span class="n">output_tsv</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ref_taxonomy_counts_</span><span class="si">{</span><span class="n">taxlevel</span><span class="si">}</span><span class="s2">.tsv&quot;</span><span class="p">),</span>
            <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span>
            <span class="n">output_pdf</span><span class="o">=</span><span class="n">outpdf</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-visualization">Module visualization</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.visualization"></a>
  <div class="doc doc-contents first">
  
      <p>Tools to visualize phylogenetic trees with and
without short read placement.</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="src.metatag.visualization.make_feature_metadata_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_feature_metadata_table</span><span class="p">(</span><span class="n">label_dict</span><span class="p">,</span> <span class="n">output_tsv</span><span class="p">,</span> <span class="n">original_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Construct feature metadata tsv classifiying reference and
query sequences for empress
https://github.com/biocore/empress/issues/548</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/visualization.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_feature_metadata_table</span><span class="p">(</span>
    <span class="n">label_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_tsv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">original_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct feature metadata tsv classifiying reference and</span>
<span class="sd">    query sequences for empress</span>
<span class="sd">    https://github.com/biocore/empress/issues/548</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">feature_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">seq_name</span> <span class="k">if</span> <span class="n">original_labels</span> <span class="k">else</span> <span class="n">seq_id</span><span class="p">:</span> <span class="s2">&quot;ref&quot;</span> <span class="k">if</span> <span class="s2">&quot;ref_&quot;</span> <span class="ow">in</span> <span class="n">seq_id</span> <span class="k">else</span> <span class="s2">&quot;query&quot;</span>
        <span class="k">for</span> <span class="n">seq_id</span><span class="p">,</span> <span class="n">seq_name</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">feature_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Sequence type&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Feature ID&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.visualization.plot_tree_in_browser" class="doc doc-heading">
<code class="highlight language-python"><span class="n">plot_tree_in_browser</span><span class="p">(</span><span class="n">input_tree</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Runs empress tree-plot
input_tree: tree in newick format
feature_metadata: path to tsv file containing feature metadata
empress: https://github.com/biocore/empress</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/visualization.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">plot_tree_in_browser</span><span class="p">(</span>
    <span class="n">input_tree</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">feature_metadata</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs empress tree-plot</span>
<span class="sd">    input_tree: tree in newick format</span>
<span class="sd">    feature_metadata: path to tsv file containing feature metadata</span>
<span class="sd">    empress: https://github.com/biocore/empress</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_tree</span><span class="p">),</span> <span class="s2">&quot;empress-plot&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">meta_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-fm </span><span class="si">{</span><span class="n">feature_metadata</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">meta_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;empress tree-plot -t </span><span class="si">{</span><span class="n">input_tree</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">meta_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new_tab</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;empress.html&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-utils">Module utils</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.utils"></a>
  <div class="doc doc-contents first">
  
      <p>Functions and classes for general purposes</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="src.metatag.utils.ConfigParser" class="doc doc-heading">
        <code>ConfigParser</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Handle MetaTag configuration file.</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ConfigParser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle MetaTag configuration file.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_default_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ConfigParser with default config file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">initialize_config_file</span><span class="p">())</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">initialize_config_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize empty config file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Path: path to generated config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;input_database&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hmm_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max_hmm_reference_size&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min_sequence_length&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max_sequence_length&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;output_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;relabel&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;remove_duplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;relabel_prefixes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hmmsearch_args&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tree_method&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config_file</span>

    <span class="k">def</span> <span class="nf">get_config_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show config file path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load config file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: dict containing fields and values of config file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">write_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write config dict to file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update config file</span>
<span class="sd">        Args:</span>
<span class="sd">            key (str): config file key name to be updated.</span>
<span class="sd">            value (str): new value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get field from config file.</span>
<span class="sd">        Args:</span>
<span class="sd">            key (str): key name to get the value from.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: key value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.get_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_config</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load config file.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dict</code></td>          <td>
                <code>dict</code>
          </td>
          <td><p>dict containing fields and values of config file.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load config file.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: dict containing fields and values of config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.get_config_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_config_path</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Show config file path.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_config_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show config file path.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.get_default_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_default_config</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize ConfigParser with default config file.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_default_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize ConfigParser with default config file.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">initialize_config_file</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.get_field" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get field from config file.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>key name to get the value from.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>key value.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get field from config file.</span>
<span class="sd">    Args:</span>
<span class="sd">        key (str): key name to get the value from.</span>
<span class="sd">    Returns:</span>
<span class="sd">        str: key value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.initialize_config_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">initialize_config_file</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize empty config file.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>Path</code></td>          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p>path to generated config file.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">initialize_config_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize empty config file.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Path: path to generated config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;config.json&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;input_database&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hmm_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_hmm_reference_size&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min_sequence_length&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_sequence_length&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;output_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;translate&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;relabel&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remove_duplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;relabel_prefixes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hmmsearch_args&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tree_method&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config_file</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.update_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_config</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update config file</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>config file key name to be updated.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>value</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>new value.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update config file</span>
<span class="sd">    Args:</span>
<span class="sd">        key (str): config file key name to be updated.</span>
<span class="sd">        value (str): new value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.ConfigParser.write_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write_config</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Write config dict to file.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write config dict to file.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.utils.DictMerger" class="doc doc-heading">
        <code>DictMerger</code>


</h2>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>src/metatag/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DictMerger</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Toos to merge python dictionaries into a single one</span>
<span class="sd">        @param</span>
<span class="sd">        dicts: list of dictionaries to be merged</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dict_list</span> <span class="o">=</span> <span class="n">dicts</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dict_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DictMerger</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize class from list of paths to dictionaries (pickle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">read_from_pickle_file</span><span class="p">(</span><span class="n">dict_path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">dict_path</span> <span class="ow">in</span> <span class="n">dict_paths</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">dicts</span><span class="o">=</span><span class="n">dict_list</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_from_pickle_file</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="s2">&quot;object.pkl&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load python object from pickle file.</span>
<span class="sd">        Returns python object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="n">python_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">in_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">python_object</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dict_prefixes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_pickle_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge dictionaries</span>
<span class="sd">        @params</span>
<span class="sd">        dict_prefixes: list of strings containing prefixes to be added to</span>
<span class="sd">                values in each dict (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dict_prefixes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict_list</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dict_prefixes</span> <span class="o">=</span> <span class="n">dict_prefixes</span>

        <span class="n">merged_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dict_object</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dict_prefixes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dict_object</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">save_pickle_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_to_pickle_file</span><span class="p">(</span><span class="n">merged_dict</span><span class="p">,</span> <span class="n">save_pickle_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged_dict</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.DictMerger.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">dicts</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Toos to merge python dictionaries into a single one
@param
dicts: list of dictionaries to be merged</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dicts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Toos to merge python dictionaries into a single one</span>
<span class="sd">    @param</span>
<span class="sd">    dicts: list of dictionaries to be merged</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dict_list</span> <span class="o">=</span> <span class="n">dicts</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.DictMerger.from_pickle_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">from_pickle_paths</span><span class="p">(</span><span class="n">dict_paths</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize class from list of paths to dictionaries (pickle)</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_pickle_paths</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dict_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DictMerger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize class from list of paths to dictionaries (pickle)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dict_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">read_from_pickle_file</span><span class="p">(</span><span class="n">dict_path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">dict_path</span> <span class="ow">in</span> <span class="n">dict_paths</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">dicts</span><span class="o">=</span><span class="n">dict_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.DictMerger.merge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">merge</span><span class="p">(</span><span class="n">dict_prefixes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_pickle_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Merge dictionaries
@params</p>

<details class="dict_prefixes">
  <summary>list of strings containing prefixes to be added to</summary>
  <p>values in each dict (optional)</p>
</details>
      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">dict_prefixes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_pickle_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge dictionaries</span>
<span class="sd">    @params</span>
<span class="sd">    dict_prefixes: list of strings containing prefixes to be added to</span>
<span class="sd">            values in each dict (optional)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dict_prefixes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dict_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict_list</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_prefixes</span> <span class="o">=</span> <span class="n">dict_prefixes</span>

    <span class="n">merged_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dict_object</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dict_prefixes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dict_object</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">save_pickle_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_to_pickle_file</span><span class="p">(</span><span class="n">merged_dict</span><span class="p">,</span> <span class="n">save_pickle_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_dict</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="src.metatag.utils.DictMerger.read_from_pickle_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_from_pickle_file</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="s1">&#39;object.pkl&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load python object from pickle file.
Returns python object.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">read_from_pickle_file</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="s2">&quot;object.pkl&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load python object from pickle file.</span>
<span class="sd">    Returns python object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">in_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">python_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
    <span class="n">in_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">python_object</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.utils.TemporaryDirectoryPath" class="doc doc-heading">
        <code>TemporaryDirectoryPath</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Custom context manager to create a temporary directory
which is removed when exiting context manager</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TemporaryDirectoryPath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom context manager to create a temporary directory</span>
<span class="sd">    which is removed when exiting context manager</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">temp_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">temp_id</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="src.metatag.utils.TemporaryFilePath" class="doc doc-heading">
        <code>TemporaryFilePath</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Custom context manager to create a temporary file
which is removed when exiting context manager</p>


        <details class="quote">
          <summary>Source code in <code>src/metatag/utils.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TemporaryFilePath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom context manager to create a temporary file</span>
<span class="sd">    which is removed when exiting context manager</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">create_file</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">extension</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_file</span> <span class="o">=</span> <span class="n">create_file</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">temp_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">temp_id</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_file</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.create_temporary_file_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_temporary_file_path</span><span class="p">(</span><span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Converted into custom context manager</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_temporary_file_path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converted into custom context manager</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">work_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">temp_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">temp_id</span><span class="si">}{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.delete_temporary_files" class="doc doc-heading">
<code class="highlight language-python"><span class="n">delete_temporary_files</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Remove files from directory</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete_temporary_files</span><span class="p">(</span><span class="n">dir_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove files from directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.easy_pattern_matching" class="doc doc-heading">
<code class="highlight language-python"><span class="n">easy_pattern_matching</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">left_pattern</span><span class="p">,</span> <span class="n">right_pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Just straightforward string searchs between two patterns</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">easy_pattern_matching</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">left_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">right_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Just straightforward string searchs between two patterns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx1</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">left_pattern</span><span class="p">)</span>
    <span class="n">left_subtext</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">idx1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_pattern</span><span class="p">)</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">right_pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">left_subtext</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">right_pattern</span><span class="p">)</span>
        <span class="n">matched_text</span> <span class="o">=</span> <span class="n">left_subtext</span><span class="p">[:</span><span class="n">idx2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matched_text</span> <span class="o">=</span> <span class="n">left_subtext</span>
    <span class="k">return</span> <span class="n">matched_text</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.extract_tar_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_tar_file</span><span class="p">(</span><span class="n">tar_file</span><span class="p">,</span> <span class="n">dest_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Extract tar or tar.gz files to dest_dir</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_tar_file</span><span class="p">(</span><span class="n">tar_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract tar or tar.gz files to dest_dir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dest_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_dir</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
    <span class="k">if</span> <span class="n">tar_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;tar.gz&quot;</span><span class="p">):</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_file</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">tar_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;tar&quot;</span><span class="p">):</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_file</span><span class="p">,</span> <span class="s2">&quot;r:&quot;</span><span class="p">)</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input is not a tar file&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.full_path_list_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">full_path_list_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return full path of files in provided directory</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">full_path_list_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return full path of files in provided directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.handle_exceptions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">handle_exceptions</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Decorator to handle possible exceptions in
given function (foo)</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">handle_exceptions</span><span class="p">(</span><span class="n">foo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator to handle possible exceptions in</span>
<span class="sd">    given function (foo)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">inner_foo</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">foo</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">foo</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> failed with exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner_foo</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.list_tar_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">list_tar_dir</span><span class="p">(</span><span class="n">tar_dir</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>List files within tar or tar.gz directory</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">list_tar_dir</span><span class="p">(</span><span class="n">tar_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List files within tar or tar.gz directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_dir</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar_obj</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">tar_obj</span><span class="o">.</span><span class="n">getnames</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">files</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.parallelize_over_input_files" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parallelize_over_input_files</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">input_list</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">callable_kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Parallelize callable over a set of input objects using a pool
of workers. Inputs in input list are passed to the first argument
of the callable.
Additional callable named arguments may be passed.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parallelize_over_input_files</span><span class="p">(</span>
    <span class="n">callable</span><span class="p">,</span> <span class="n">input_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">callable_kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parallelize callable over a set of input objects using a pool</span>
<span class="sd">    of workers. Inputs in input list are passed to the first argument</span>
<span class="sd">    of the callable.</span>
<span class="sd">    Additional callable named arguments may be passed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_processes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_processes</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="o">**</span><span class="n">callable_kwargs</span><span class="p">),</span> <span class="n">input_list</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.read_from_pickle_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_from_pickle_file</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="s1">&#39;object.pkl&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Load python object from pickle file.
Returns python object.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_from_pickle_file</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="s2">&quot;object.pkl&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load python object from pickle file.</span>
<span class="sd">    Returns python object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">in_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">python_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
    <span class="n">in_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">python_object</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.save_to_pickle_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save_to_pickle_file</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">path_to_file</span><span class="o">=</span><span class="s1">&#39;object.pkl&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Save python object to pickle file</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_to_pickle_file</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">path_to_file</span><span class="o">=</span><span class="s2">&quot;object.pkl&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save python object to pickle file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
    <span class="n">out_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.set_default_output_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get default path to output file or directory</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_default_output_path</span><span class="p">(</span>
    <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">only_filename</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">only_dirname</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get default path to output file or directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_path</span><span class="p">))</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">ext</span>
    <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">default_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}{</span><span class="n">tag</span><span class="si">}{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">only_filename</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_file</span>
    <span class="k">if</span> <span class="n">only_dirname</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">default_file</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.utils.terminal_execute" class="doc doc-heading">
<code class="highlight language-python"><span class="n">terminal_execute</span><span class="p">(</span><span class="n">command_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Execute given command in terminal through Python.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>command_str</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>terminal command to be executed.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>suppress_shell_output</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>suppress shell output. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>work_dir</code></td>
          <td>
                <code><span title="pathlib.Path">Path</span></code>
          </td>
          <td><p>change working directory. Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>return_output</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to return execution output. Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>subprocess.<span title="subprocess.STDOUT">STDOUT</span></code>
          </td>
          <td><p>subprocess.STDOUT: subprocess output.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/metatag/utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">terminal_execute</span><span class="p">(</span>
    <span class="n">command_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">work_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">return_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute given command in terminal through Python.</span>
<span class="sd">    Args:</span>
<span class="sd">        command_str (str): terminal command to be executed.</span>
<span class="sd">        suppress_shell_output (bool, optional): suppress shell output. Defaults to False.</span>
<span class="sd">        work_dir (Path, optional): change working directory. Defaults to None.</span>
<span class="sd">        return_output (bool, optional): whether to return execution output. Defaults to False.</span>
<span class="sd">    Returns:</span>
<span class="sd">        subprocess.STDOUT: subprocess output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">suppress_shell_output</span><span class="p">:</span>
        <span class="n">command_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">command_str</span><span class="si">}</span><span class="s2"> &gt;/dev/null 2&gt;&amp;1&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">command_str</span> <span class="o">=</span> <span class="n">command_str</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">command_str</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="n">return_output</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="module-wrappers">Module wrappers</h2>


<div class="doc doc-object doc-module">


<a id="src.metatag.wrappers"></a>
  <div class="doc doc-contents first">
  
      <p>Simple CLI wrappers to several tools</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.get_percent_identity_from_msa" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_percent_identity_from_msa</span><span class="p">(</span><span class="n">input_msa</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Run esl-alipid to compute pairwise PI from a MSA.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_percent_identity_from_msa</span><span class="p">(</span><span class="n">input_msa</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run esl-alipid to compute pairwise PI from a MSA.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_msa</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_msa</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_msa</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_PI&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;esl-alipid </span><span class="si">{</span><span class="n">input_msa</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_cdhit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_cdhit</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to cd-hit to obtain representative sequences
CD-HIT may be used to remove duplicated sequences (keeps one representative)
with parameters -c 1 -t 1.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_cdhit</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to cd-hit to obtain representative sequences</span>
<span class="sd">    CD-HIT may be used to remove duplicated sequences (keeps one representative)</span>
<span class="sd">    with parameters -c 1 -t 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;_cdhit&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">input_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cd-hit -i </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">output_fasta</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">additional_args</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_epang" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_epang</span><span class="p">(</span><span class="n">input_tree</span><span class="p">,</span> <span class="n">input_aln_ref</span><span class="p">,</span> <span class="n">input_aln_query</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite_previous_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to EPA-ng
See epa-ng -h for additional parameters
input_tree: newick format
input_aln: fasta format
input_aln_query: fasta format (sequences must be alignned to reference
msa fasta and have the same length as the reference msa alignment)
epa-ng: https://github.com/Pbdas/epa-ng</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_epang</span><span class="p">(</span>
    <span class="n">input_tree</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_aln_ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_aln_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite_previous_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to EPA-ng</span>
<span class="sd">    See epa-ng -h for additional parameters</span>
<span class="sd">    input_tree: newick format</span>
<span class="sd">    input_aln: fasta format</span>
<span class="sd">    input_aln_query: fasta format (sequences must be alignned to reference</span>
<span class="sd">    msa fasta and have the same length as the reference msa alignment)</span>
<span class="sd">    epa-ng: https://github.com/Pbdas/epa-ng</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;GTR+G&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_tree</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_threads</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">overwrite_previous_results</span><span class="p">:</span>
        <span class="n">overwrite_str</span> <span class="o">=</span> <span class="s2">&quot;--redo&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">overwrite_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;epa-ng --ref-msa </span><span class="si">{</span><span class="n">input_aln_ref</span><span class="si">}</span><span class="s2"> --tree </span><span class="si">{</span><span class="n">input_tree</span><span class="si">}</span><span class="s2"> --query </span><span class="si">{</span><span class="n">input_aln_query</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;--model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> --threads </span><span class="si">{</span><span class="n">n_threads</span><span class="si">}</span><span class="s2"> --outdir </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">overwrite_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_fastp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_fastp</span><span class="p">(</span><span class="n">input_fastq1</span><span class="p">,</span> <span class="n">input_fastq2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">merged_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to Fastp
https://github.com/OpenGene/fastp</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_fastp</span><span class="p">(</span>
    <span class="n">input_fastq1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_fastq2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">merge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">merged_out</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to Fastp</span>
<span class="sd">    https://github.com/OpenGene/fastp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_fastq2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-i </span><span class="si">{</span><span class="n">input_fastq1</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">input_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-i </span><span class="si">{</span><span class="n">input_fastq1</span><span class="si">}</span><span class="s2"> -I </span><span class="si">{</span><span class="n">input_fastq2</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">n_threads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">threads_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--thread </span><span class="si">{</span><span class="n">n_threads</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threads_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fastq1</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
        <span class="n">merged_out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">merged_out</span>
            <span class="k">if</span> <span class="n">merged_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;merged.fastq&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--merge --merged_out </span><span class="si">{</span><span class="n">merged_out</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;-o </span><span class="si">{</span><span class="s2">&quot;fastp_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">input_fastq1</span><span class="si">}</span><span class="s1"> -O </span><span class="si">{</span><span class="s2">&quot;fastp_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">input_fastq2</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fastp </span><span class="si">{</span><span class="n">input_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">out_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">threads_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_fasttree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_fasttree</span><span class="p">(</span><span class="n">input_algns</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nucleotides</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">starting_tree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to fasttree.
fasttree accepts multiple alignments in fasta or phylip formats
It seems that fasttree does not allow inputing subsitution model.
Default substitution model for protein seqs is JTT</p>

<details class="additional_args">
  <summary>a string containing additional parameters and</summary>
  <p>parameter values to be passed to fasttree</p>
</details>
      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_fasttree</span><span class="p">(</span>
    <span class="n">input_algns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nucleotides</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">starting_tree</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to fasttree.</span>
<span class="sd">    fasttree accepts multiple alignments in fasta or phylip formats</span>
<span class="sd">    It seems that fasttree does not allow inputing subsitution model.</span>
<span class="sd">    Default substitution model for protein seqs is JTT</span>

<span class="sd">    additional_args: a string containing additional parameters and</span>
<span class="sd">                     parameter values to be passed to fasttree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_algns</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_fasttree&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.newick&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">nucleotides</span><span class="p">:</span>
        <span class="n">nt_str</span> <span class="o">=</span> <span class="s2">&quot;-gtr -nt&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nt_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">starting_tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_t_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-intree </span><span class="si">{</span><span class="n">starting_tree</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_t_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">input_algns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_algns</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;fasttree </span><span class="si">{</span><span class="n">nt_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_algns</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_t_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">additional_args</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_gappa_assign" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_gappa_assign</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">taxonomy_file</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">only_best_hit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delete_output_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Use gappa examine assign to assign taxonomy to placed query sequences
based on taxonomy assigned to tree reference sequences</p>
<p>argument: --resolve-missing-paths alongside --root-outgroup can be
added to find missing taxonomic info in labels.</p>
<p>Info: https://github.com/lczech/gappa/wiki/Subcommand:-assign</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_gappa_assign</span><span class="p">(</span>
    <span class="n">jplace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">taxonomy_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">only_best_hit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delete_output_tree</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use gappa examine assign to assign taxonomy to placed query sequences</span>
<span class="sd">    based on taxonomy assigned to tree reference sequences</span>

<span class="sd">    argument: --resolve-missing-paths alongside --root-outgroup can be</span>
<span class="sd">    added to find missing taxonomic info in labels.</span>

<span class="sd">    Info: https://github.com/lczech/gappa/wiki/Subcommand:-assign</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">jplace</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only_best_hit</span><span class="p">:</span>
        <span class="n">best_str</span> <span class="o">=</span> <span class="s2">&quot;--best-hit&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;gappa examine assign --jplace-path </span><span class="si">{</span><span class="n">jplace</span><span class="si">}</span><span class="s2"> --taxon-file </span><span class="si">{</span><span class="n">taxonomy_file</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;--out-dir </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2"> --file-prefix </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2"> --allow-file-overwriting &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;--per-query-results </span><span class="si">{</span><span class="n">best_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">outtree</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">labelled_tree.newick&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delete_output_tree</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outtree</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outtree</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_gappa_graft" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_gappa_graft</span><span class="p">(</span><span class="n">input_jplace</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Run gappa examine graft to obtain tree with placements in
newick format</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_gappa_graft</span><span class="p">(</span>
    <span class="n">input_jplace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run gappa examine graft to obtain tree with placements in</span>
<span class="sd">    newick format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outdir_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outdir_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--out-dir </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">output_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_prefix_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_prefix_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--file-prefix </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>

    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;gappa examine graft --jplace-path </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_jplace</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outdir_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">output_prefix_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_gappa_heat_tree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_gappa_heat_tree</span><span class="p">(</span><span class="n">input_jplace</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Run gappa examine heat-tree to obtain heat-map tree
representing densities of placed short reads in svg
or pdf formats</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_gappa_heat_tree</span><span class="p">(</span>
    <span class="n">input_jplace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run gappa examine heat-tree to obtain heat-map tree</span>
<span class="sd">    representing densities of placed short reads in svg</span>
<span class="sd">    or pdf formats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outdir_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outdir_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--out-dir </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">output_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_prefix_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_prefix_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--file-prefix </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>

    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;gappa examine heat-tree --jplace-path </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_jplace</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;--write-svg-tree &quot;</span>  <span class="c1"># --write-newick-tree</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outdir_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">output_prefix_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_hmmalign" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_hmmalign</span><span class="p">(</span><span class="n">input_hmm</span><span class="p">,</span> <span class="n">input_aln</span><span class="p">,</span> <span class="n">input_seqs</span><span class="p">,</span> <span class="n">output_aln_seqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to hmmalign
Align short read query sequences to reference MSA</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_hmmalign</span><span class="p">(</span>
    <span class="n">input_hmm</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_aln</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_seqs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_aln_seqs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to hmmalign</span>
<span class="sd">    Align short read query sequences to reference MSA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_aln_seqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_aln_seqs</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_seqs</span><span class="p">,</span> <span class="s2">&quot;_hmm&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.aln&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">input_hmm</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_hmm</span><span class="p">)</span>
    <span class="n">input_aln</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_aln</span><span class="p">)</span>
    <span class="n">input_seqs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_seqs</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;hmmalign -o </span><span class="si">{</span><span class="n">output_aln_seqs</span><span class="si">}</span><span class="s2"> --mapali </span><span class="si">{</span><span class="n">input_aln</span><span class="si">}</span><span class="s2"> --trim &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;--informat fasta </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_hmm</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_seqs</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_hmmbuild" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_hmmbuild</span><span class="p">(</span><span class="n">input_aln</span><span class="p">,</span> <span class="n">output_hmm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to hmmbuild (build HMM profile from MSA file)
additional args: see hmmbuild -h</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_hmmbuild</span><span class="p">(</span>
    <span class="n">input_aln</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_hmm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to hmmbuild (build HMM profile from MSA file)</span>
<span class="sd">    additional args: see hmmbuild -h</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_hmm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_hmm</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_aln</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.hmm&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hmmbuild </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">output_hmm</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_aln</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_hmmsearch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_hmmsearch</span><span class="p">(</span><span class="n">hmm_model</span><span class="p">,</span> <span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hmmsearch&#39;</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to hmmsearch or hmmscan</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_hmmsearch</span><span class="p">(</span>
    <span class="n">hmm_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hmmsearch&quot;</span><span class="p">,</span>
    <span class="n">n_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to hmmsearch or hmmscan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_processes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="s2">&quot;_hmmer_hits&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> --tblout </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2"> --cpu </span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hmm_model</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_iqtree" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_iqtree</span><span class="p">(</span><span class="n">input_algns</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_recovery_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nucleotides</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">substitution_model</span><span class="o">=</span><span class="s1">&#39;TEST&#39;</span><span class="p">,</span> <span class="n">starting_tree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bootstrap_replicates</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_bootstrap_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">overwrite_previous_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to iqtree.
iqtree accepts multiple alignments in fasta or phylip formats.</p>

<details class="additional_args">
  <summary>a string containing additional parameters and</summary>
  <p>parameter values to be passed to iqtree</p>
</details>      <p>output: iqtree outputs several files</p>
<p>Reducing computational time via model selection:
http://www.iqtree.org/doc/Command-Reference</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_iqtree</span><span class="p">(</span>
    <span class="n">input_algns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">keep_recovery_files</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">nucleotides</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">n_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">substitution_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TEST&quot;</span><span class="p">,</span>
    <span class="n">starting_tree</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bootstrap_replicates</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">max_bootstrap_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">overwrite_previous_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to iqtree.</span>
<span class="sd">    iqtree accepts multiple alignments in fasta or phylip formats.</span>

<span class="sd">    additional_args: a string containing additional parameters and</span>
<span class="sd">                     parameter values to be passed to iqtree</span>

<span class="sd">    output: iqtree outputs several files</span>

<span class="sd">    Reducing computational time via model selection:</span>
<span class="sd">    http://www.iqtree.org/doc/Command-Reference</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">remove_auxiliary_output</span><span class="p">(</span><span class="n">output_prefix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes iqtree auxiliary output files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exts_to_remove</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;.bionj&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.ckp.gz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.iqtree&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.log&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.model.gz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.splits.nex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.mldist&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">files_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">output_prefix</span> <span class="o">+</span> <span class="n">ext</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts_to_remove</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_remove</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_algns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_algns</span><span class="p">)</span>
        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">input_file</span><span class="p">)</span>
        <span class="n">output_prefix_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-pre </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_prefix</span><span class="p">)</span>
        <span class="n">output_prefix_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-pre </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">nucleotides</span><span class="p">:</span>
        <span class="n">seq_type</span> <span class="o">=</span> <span class="s2">&quot;DNA&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seq_type</span> <span class="o">=</span> <span class="s2">&quot;AA&quot;</span>
    <span class="k">if</span> <span class="n">n_processes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="s2">&quot;AUTO&quot;</span>
    <span class="k">if</span> <span class="n">starting_tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_t_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-t </span><span class="si">{</span><span class="n">starting_tree</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_t_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">overwrite_previous_results</span><span class="p">:</span>
        <span class="n">overwrite_str</span> <span class="o">=</span> <span class="s2">&quot;-redo&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">overwrite_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">input_algns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_algns</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;iqtree -s </span><span class="si">{</span><span class="n">input_algns</span><span class="si">}</span><span class="s2"> -st </span><span class="si">{</span><span class="n">seq_type</span><span class="si">}</span><span class="s2"> -nt </span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-m </span><span class="si">{</span><span class="n">substitution_model</span><span class="si">}</span><span class="s2"> -bb </span><span class="si">{</span><span class="n">bootstrap_replicates</span><span class="si">}</span><span class="s2"> -mset raxml &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-nm </span><span class="si">{</span><span class="n">max_bootstrap_iterations</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_prefix_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_t_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">overwrite_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">additional_args</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_recovery_files</span><span class="p">:</span>
        <span class="n">remove_auxiliary_output</span><span class="p">(</span><span class="n">output_prefix</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_mafft" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_mafft</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to mafft (MSA)</p>
<p>Manual: https://mafft.cbrc.jp/alignment/software/manual/manual.html</p>
<p>CLI examples:
mafft --globalpair --thread n in &gt; out
mafft --localpair --thread n in &gt; out
mafft --large --globalpair --thread n in &gt; out</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_mafft</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to mafft (MSA)</span>

<span class="sd">    Manual: https://mafft.cbrc.jp/alignment/software/manual/manual.html</span>

<span class="sd">    CLI examples:</span>
<span class="sd">    mafft --globalpair --thread n in &gt; out</span>
<span class="sd">    mafft --localpair --thread n in &gt; out</span>
<span class="sd">    mafft --large --globalpair --thread n in &gt; out</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.fasta.aln&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">thread_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--thread </span><span class="si">{</span><span class="n">n_threads</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thread_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">input_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mafft </span><span class="si">{</span><span class="n">thread_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">additional_args</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_modeltest" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_modeltest</span><span class="p">(</span><span class="n">input_algns</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to modeltest-ng
Repo: https://github.com/ddarriba/modeltest</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_modeltest</span><span class="p">(</span>
    <span class="n">input_algns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to modeltest-ng</span>
<span class="sd">    Repo: https://github.com/ddarriba/modeltest</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_algns</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s2">&quot;modeltest_result&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;modeltest_result&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n_processes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;modeltest-ng -i </span><span class="si">{</span><span class="n">input_algns</span><span class="si">}</span><span class="s2"> -T raxml -d aa -p </span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-o </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_muscle" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_muscle</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to muscle (MSA)
muscle: https://www.drive5.com/muscle/manual/output_formats.html</p>
<p>output phylip and fasta.aln</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_muscle</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">maxiters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to muscle (MSA)</span>
<span class="sd">    muscle: https://www.drive5.com/muscle/manual/output_formats.html</span>

<span class="sd">    output phylip and fasta.aln</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">input_fasta</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.fasta.aln&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">maxiters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxiters</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">input_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;muscle -in </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2"> -out </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-maxiters </span><span class="si">{</span><span class="n">maxiters</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_papara" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_papara</span><span class="p">(</span><span class="n">tree_nwk</span><span class="p">,</span> <span class="n">msa_phy</span><span class="p">,</span> <span class="n">query_fasta</span><span class="p">,</span> <span class="n">output_aln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to Papara. Output lignment in fasta format</p>
<p>Run Papara to do query alignment to reference MSA and tree (required for EPA-ng)
Alignment could be done with hmmalign or muscle as well, but these tools don't
consider the tree during alignment (would this be a justified improvement over hmmalign?)</p>
<p>There seems to be a problem with enabling multithreading in papara when run as a static
executable. It looks like it has to be enabled during compilation (but compilation currently not working):
https://stackoverflow.com/questions/19618926/thread-doesnt-work-with-an-error-enable-multithreading-to-use-stdthread-ope</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_papara</span><span class="p">(</span>
    <span class="n">tree_nwk</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">msa_phy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">query_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_aln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to Papara. Output lignment in fasta format</span>

<span class="sd">    Run Papara to do query alignment to reference MSA and tree (required for EPA-ng)</span>
<span class="sd">    Alignment could be done with hmmalign or muscle as well, but these tools don&#39;t</span>
<span class="sd">    consider the tree during alignment (would this be a justified improvement over hmmalign?)</span>

<span class="sd">    There seems to be a problem with enabling multithreading in papara when run as a static</span>
<span class="sd">    executable. It looks like it has to be enabled during compilation (but compilation currently not working):</span>
<span class="sd">    https://stackoverflow.com/questions/19618926/thread-doesnt-work-with-an-error-enable-multithreading-to-use-stdthread-ope</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tree_nwk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">tree_nwk</span><span class="p">)</span>
    <span class="n">msa_phy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msa_phy</span><span class="p">)</span>
    <span class="n">query_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">query_fasta</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_aln</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_aln</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
            <span class="n">query_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_ref_aln&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.phylip&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_aln</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_aln</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">papara_exec</span><span class="si">}</span><span class="s2"> -t </span><span class="si">{</span><span class="n">tree_nwk</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-s </span><span class="si">{</span><span class="n">msa_phy</span><span class="si">}</span><span class="s2"> -q </span><span class="si">{</span><span class="n">query_fasta</span><span class="si">}</span><span class="s2"> -n phylip &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-r </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2"> -a&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="s2">&quot;papara_alignment.phylip&quot;</span><span class="p">),</span> <span class="n">output_aln</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_prodigal" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_prodigal</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metagenome</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to prodigal</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_prodigal</span><span class="p">(</span>
    <span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metagenome</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to prodigal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">metagenome</span><span class="p">:</span>
        <span class="n">procedure</span> <span class="o">=</span> <span class="s2">&quot;meta&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">procedure</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">only_dirname</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">output_gbk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;.gbk&quot;</span><span class="p">)</span>
    <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;.faa&quot;</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;prodigal -i </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">output_gbk</span><span class="si">}</span><span class="s2"> -p </span><span class="si">{</span><span class="n">procedure</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-a </span><span class="si">{</span><span class="n">output_fasta</span><span class="si">}</span><span class="s2"> -q </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_seqkit_nodup" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_seqkit_nodup</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">output_fasta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">duplicates_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simpe CLI wrapper to seqkit rmdup</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_seqkit_nodup</span><span class="p">(</span>
    <span class="n">input_fasta</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_fasta</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">export_duplicates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">duplicates_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simpe CLI wrapper to seqkit rmdup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_fasta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_fasta</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_no_duplicates&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">export_duplicates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">duplicates_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dup_file</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
                <span class="n">input_fasta</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_duplicates&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dup_file</span> <span class="o">=</span> <span class="n">duplicates_file</span>
        <span class="n">dup_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-D </span><span class="si">{</span><span class="n">dup_file</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dup_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;seqkit rmdup </span><span class="si">{</span><span class="n">input_fasta</span><span class="si">}</span><span class="s2"> --quiet -s </span><span class="si">{</span><span class="n">dup_str</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">output_fasta</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_tree_shrink" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_tree_shrink</span><span class="p">(</span><span class="n">input_tree</span><span class="p">,</span> <span class="n">input_aln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_deleted_nodes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Run treeshrink to remove tree branch outliers.
Remove outliers from MSA file too.
Tree file must be of newick format.
See run_treeshrink.py  -h for help
Currently using default parameter values.</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_tree_shrink</span><span class="p">(</span>
    <span class="n">input_tree</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">input_aln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_deleted_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">additional_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run treeshrink to remove tree branch outliers.</span>
<span class="sd">    Remove outliers from MSA file too.</span>
<span class="sd">    Tree file must be of newick format.</span>
<span class="sd">    See run_treeshrink.py  -h for help</span>
<span class="sd">    Currently using default parameter values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">input_tree</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">additional_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="n">additional_args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">input_tree</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_tree</span><span class="p">)</span>
    <span class="n">out_tree</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_tree</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_shrink&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_aln</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">input_aln</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_aln</span><span class="p">)</span>
        <span class="n">out_aln</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_aln</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_shrink&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">aln_str</span> <span class="o">=</span> <span class="s2">&quot;-a input.aln&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aln_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Handle treeshrink input/output requirements (temp/tree/input.tree)</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_out_dir</span><span class="p">,</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">parent_in_temp</span><span class="p">,</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span>
        <span class="nb">dir</span><span class="o">=</span><span class="n">parent_in_temp</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">temp_in_dir</span><span class="p">:</span>
        <span class="n">temp_tree_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">temp_in_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">input_tree</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_in_dir</span><span class="p">,</span> <span class="s2">&quot;input.tree&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">input_aln</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">input_aln</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_in_dir</span><span class="p">,</span> <span class="s2">&quot;input.aln&quot;</span><span class="p">))</span>

        <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_treeshrink.py -i </span><span class="si">{</span><span class="n">parent_in_temp</span><span class="si">}</span><span class="s2"> -m per-gene &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-t input.tree </span><span class="si">{</span><span class="n">aln_str</span><span class="si">}</span><span class="s2"> --force &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-o </span><span class="si">{</span><span class="n">temp_out_dir</span><span class="si">}</span><span class="s2"> -O output </span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_out_dir</span><span class="p">,</span> <span class="n">temp_tree_dir</span><span class="p">,</span> <span class="s2">&quot;output.tree&quot;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">out_tree</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">input_aln</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_out_dir</span><span class="p">,</span> <span class="n">temp_tree_dir</span><span class="p">,</span> <span class="s2">&quot;output.aln&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">out_aln</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">output_deleted_nodes</span><span class="p">:</span>
            <span class="n">out_txt</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span>
                <span class="n">input_tree</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;_shrink_deleted&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="n">only_filename</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_out_dir</span><span class="p">,</span> <span class="n">temp_tree_dir</span><span class="p">,</span> <span class="s2">&quot;output.txt&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">out_txt</span><span class="p">),</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.metatag.wrappers.run_trimal" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_trimal</span><span class="p">(</span><span class="n">input_aln</span><span class="p">,</span> <span class="n">output_aln</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Simple CLI wrapper to trimal</p>
<p>I/O in phylip as well: https://vicfero.github.io/trimal/</p>

      <details class="quote">
        <summary>Source code in <code>src/metatag/wrappers.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_trimal</span><span class="p">(</span><span class="n">input_aln</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_aln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple CLI wrapper to trimal</span>

<span class="sd">    I/O in phylip as well: https://vicfero.github.io/trimal/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_aln</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_aln</span> <span class="o">=</span> <span class="n">set_default_output_path</span><span class="p">(</span><span class="n">input_aln</span><span class="p">,</span> <span class="s2">&quot;_trimal&quot;</span><span class="p">)</span>
    <span class="n">input_aln</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_aln</span><span class="p">)</span>
    <span class="n">cmd_str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;trimal -in </span><span class="si">{</span><span class="n">input_aln</span><span class="si">}</span><span class="s2"> -out </span><span class="si">{</span><span class="n">output_aln</span><span class="si">}</span><span class="s2"> -fasta -automated1 &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;-resoverlap 0.55 -seqoverlap 60 -htmlout trimal.html&quot;</span>
    <span class="p">)</span>
    <span class="n">terminal_execute</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">suppress_shell_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../subcommands/relabel/" class="btn btn-neutral float-left" title="Relabel"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/Robaina/MetaTag" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../subcommands/relabel/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../javascripts/mathjax.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
